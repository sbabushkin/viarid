require([
	'jquery', 
	'mage/translate', 
	'apptusjs', 
	'Apptus_Apptus/js/view/submit-filter', 
	'Apptus_Apptus/js/view/ajax', 
	'slickSlider',
	'collapsible'
], function ($, $t, apptusjs, submitFilterAction, ajaxupdate) {
	dataLayer = window.dataLayer || [];
	api = apptusjs.esalesAPI({
		market: $('.apptus_market').val(),
		clusterId: $('.apptus_clusterid').val()
	});
	var lowerCaseMarketId = $('.market_id').val().toLowerCase();
	var nextclick = false;
	var categoryName = '';
	let isShowMore = false;
	function getVisible() {    
		var $el = $('#maincontent'),
			scrollTop = $(this).scrollTop(),
			scrollBot = scrollTop + $(this).height(),
			elTop = $el.offset().top,
			elBottom = elTop + $el.outerHeight(),
			visibleTop = elTop < scrollTop ? scrollTop : elTop,
			visibleBottom = elBottom > scrollBot ? scrollBot : elBottom;
			return visibleBottom - visibleTop;
	}
	function findUrlParamValue(paramname, value) { 
		var availablity = false;
		var parser = document.createElement('a');
		parser.href = window.location.href;
		var query = parser.search.substring(1);
		var vars = query.split('&');
		for (var i = 0; i < vars.length; i++) {
			var pair = vars[i].split('=');
			if(pair[0] == paramname && pair[1] == value){
				availablity = true;
			}
		}
		return availablity;			
	}
	
	function findUrlParamAvailable(paramname) { 
		var availablity = false;
		var parser = document.createElement('a');
		parser.href = window.location.href;
		var query = parser.search.substring(1);
		var vars = query.split('&');
		for (var i = 0; i < vars.length; i++) {
			var pair = vars[i].split('=');
			if(pair[0] == paramname){
				availablity = true;
			}
		}
		return availablity;			
	}
	function findUrlParamAvailableValue(paramname) { 
		var availablity = '';
		var parser = document.createElement('a');
		parser.href = window.location.href;
		var query = parser.search.substring(1);
		var vars = query.split('&');
		for (var i = 0; i < vars.length; i++) {
			var pair = vars[i].split('=');
			if(pair[0] == paramname){
				availablity = pair[1];
			}
		}
		return availablity;			
	}
	function replaceSpecialChrs(inputstr) {    
		var value = inputstr.replace(/[^a-zA-Z_]/g, "");
		return value;
	}
	
	function changeMenuHeight() { 
		$('#apptussearchFacets .filter-options-item .filter-options-title').each(function() {
			$(this).click(function () {
				setTimeout(function() {
				var dropdownHeight = $('.active ol').height();
				var visibleWindow = getVisible()-100;
					if(dropdownHeight > visibleWindow){
					  $('#apptussearchFacets .active .filter-options-content').css({"height": visibleWindow+"px","overflow-y": "scroll"});
					}
				}, 705);
			});
		});
	}

	function addToWishlistBag(){

		$(document).on('click', `.ajax-add-to-wishlist`, function (e) {
			let pid = $(this).attr('rev');
			e.preventDefault();    
			var self =  this;
			var url = $(this).attr('rel');
			$.ajax({
				url: url,
				type: "POST",
				data: {'pid': pid},
				showLoader: true,
				success: function (response) {
					response = JSON.parse(response);
					if(response.code == 'Success'){
						if(response.flag){
							$(self).addClass('addedInWishlist');
							$(".spwishlist"+pid).addClass('addedInWishlist');
						}else{
							if($(self).hasClass('remove-favorite')){
								$('#item_'+pid).remove();
								$(".spwishlist"+pid).removeClass('addedInWishlist');
							}else{
								$(self).removeClass('addedInWishlist');
								$(".spwishlist"+pid).removeClass('addedInWishlist');
							}
						}
						myHmList = getCookie('myhmlist'+websitecode);
						//var msg = '<div class="message success"><span>'+$t('Product added successfully in Favourites.')+'</span></div>';						
					}else{
						var msg = '<div class="message success"><span>'+$t('Something went wrong during adding product to Favourites.')+'</span></div>';
					}
					if ($('body').hasClass('catalog-product-view')) {
						$(".pdp-wrap-top .page.messages").after(msg);
					}else{
						$(".page-header").after(msg);
					}
					setTimeout(function(){ 
						$(".message").hide();
					}, 5000);
				}
			});
		});
	}
	function changePriceFormat(priceval){
		return priceval.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
	}
	function searchTemplate(response, categoryOne='', categoryTwo=''){
			var resultHtml = '';
			var media_bucket_url = $('.media_bucket_url').val();
			var site_base_url = $('.site_base_url').val();
			var siteBaseUrlWithoutSlash = site_base_url.slice(0,-1);
			
			var impressionjson = [];
			var impressionlist = 'Catalog Page';
			if($('.current_page_action').val() == 'catalogsearch_result_index'){
				impressionpage = 'search_result_list';
			}
			
			if(response.products != undefined && response.products != '' && response.products.length > 0){
				var products = response.products;
				var productsCount = response.products.length;
				for(var i=0; i < productsCount; i++){
					var proAttributes = products[i].attributes;
					var pticket = products[i].ticket;
					var productid = ''; if(proAttributes.entity_id != undefined){ productid = proAttributes.entity_id[0]; }
					var article_number = ''; if(proAttributes.article_number != undefined){ article_number = proAttributes.article_number[0]; }
					var proname = ''; if(proAttributes.product_name != undefined){ proname = proAttributes.product_name[0]; }
					var prourl = ''; if(proAttributes.url != undefined){ prourl = proAttributes.url[0]; }
					let productColor = ''; if(proAttributes.color != undefined){ productColor = proAttributes.color[0]; }
					let brand = '';
					let artNo = products[0].key;
					let locale = artNo.substr(artNo.length - 2);
					if(products.length > 0) {
						if (locale=="id") {
							brand = "H&M Indonesia";
						} else if(locale=="th") {
							brand = "H&M Thailand";
						}
					}
					let imgAlt = categoryOne+' '+productColor+' '+proname;
					if( categoryTwo.length > 0 ) { imgAlt += ' | '+categoryTwo; }
					imgAlt += ' | '+brand;
					var pathName = window.location.pathname.split('/');
					if (pathName[1] == "th_th") {
						imgAlt = proAttributes.product_name_TH[0];
					}
					if (pathName[1] == "id_id") {
						imgAlt = proAttributes.product_name_ID[0];
					}
					if (pathName[1] && $.inArray(pathName[1], ['id_id', 'id_en', 'th_en', 'th_th']) >= 0) {
						var storeCodes = pathName[1].toUpperCase().split('_');
						if (storeCodes[1] && storeCodes[1] != 'EN') {
							let productName = 'product_name_' + storeCodes[1];
							if (proAttributes[productName]) {
								proname = proAttributes[productName][0];
							}
						}
					}
					var stilllifemediumm = '';  var lookbookmdiumm = ''; 
					if(proAttributes.lookbook != undefined && proAttributes.lookbook[0] != undefined){
						lookbookmdiumm = proAttributes.lookbook[0];
					}
					
					if(proAttributes.image_url != undefined && proAttributes.image_url[0] != undefined){
						stilllifemediumm = proAttributes.image_url[0];
					}
			resultHtml += '<li class="item product product-item"  onclick="api.notify.click(\''+pticket+'\')">';
			resultHtml += '		<div class="product-item-info" data-container="product-grid">';
			resultHtml += '			<div class="product-img-wrapper">';
										
			resultHtml += '				<a href="'+siteBaseUrlWithoutSlash+prourl+'" class="product photo product-item-photo" tabindex="-1">';
			resultHtml += '					<span class="product-image-container" style="width:564px;">';
			resultHtml += '						<span class="product-image-wrapper" style="padding-bottom: 150%;">';
						
			resultHtml += '						<img data-original="'+lookbookmdiumm+'" src="data:image/gif;base64,R0lGODlhAQABAIABAP///wAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" class="product-image-photo lazy" data-modal-image="'+lookbookmdiumm+'" data-product-image="'+stilllifemediumm+'" data-default-image="'+lookbookmdiumm+'" data-hover-image="'+stilllifemediumm+'" alt="'+imgAlt+'" style="display: block;" data-src="'+lookbookmdiumm+'" width="" height="">';

			resultHtml += '					     </span>';
			resultHtml += '					</span>';         
			resultHtml += '				</a>';
			var dmyHmList = decodeURIComponent(myHmList).split(','); //decoded list
            wishlistClass = '';
            if(dmyHmList){
                $.each(dmyHmList,function(i,v){
                    if(productid == v || article_number == v){
                        wishlistClass = 'addedInWishlist';
                    }
                });
            }
			resultHtml += '				<div data-role="add-to-links" class="actions-secondary">';
			resultHtml += '					<a id="wishlist'+productid+'" href="javascript:void(0)" class="action towishlist ajax-add-to-wishlist  spwishlist'+productid+' '+wishlistClass+'" title="'+$t("Add to Wish List")+'" aria-label="'+$t("Add to Wish List")+'" rel="'+site_base_url+'specommerce/wishlist/add" rev="'+proAttributes.entity_id[0]+'" data-action="add-to-wishlist" role="button">';
			resultHtml += '						<span>'+$t("Add to Wish List")+'</span>';
			resultHtml += '					</a>';
			resultHtml += '				</div>';
			resultHtml += '				<div class="price-marker-plp">';
			resultHtml += '					<span class="price-container">';
											var variants = products[i].variants;
											var variantsLength = products[i].variants.length;
											if(variantsLength > 0){
												for(var vari=0; vari < variantsLength; vari++){
			resultHtml += '						<span class="price">'+variants[vari].attributes.size[0]+'</span>';
												}
											}
			resultHtml += '					</span>';
			resultHtml += '				</div>';
			resultHtml += '			</div>';
									var colorfilter = '';
										if(proAttributes.color_filter != undefined && proAttributes.color_filter != ''){
											var color = proAttributes.color_filter[0].split('_');
											colorfilter = color[1];
										}
				var colorcode = '';
				if(proAttributes.color_code != undefined && proAttributes.color_code != ''){
					colorcode = proAttributes.color_code[0];
				}
				var listCartUrl = site_base_url+'checkout/cart/add'+''+'/product/'+productid+'/';
				var productkey = products[i].key;
				var sizeguide = '';
				if(proAttributes.customer_groups != undefined && proAttributes.customer_groups[0] != ''){
					var sizeguides  = JSON.parse(sizeguidesLists);
					var customerGroup = proAttributes.customer_groups[0];
					customerGroup = customerGroup.toLowerCase();
					sizeguide = sizeguides[customerGroup];
				}
				var allproducts = '';
				let invalidArticles = [];
				if (proAttributes.article_out_of_stock !== undefined
					&& proAttributes.article_out_of_stock[0] !== undefined
					&& proAttributes.article_out_of_stock[0] !== ''
				) {
					let articleOos = proAttributes.article_out_of_stock[0].split('|');
					invalidArticles.push(...articleOos);
				}
				if (proAttributes.article_expired !== undefined
					&& proAttributes.article_expired[0] !== undefined
					&& proAttributes.article_expired[0] !== ''
				) {
					let articleExpired = proAttributes.article_expired[0].split('|');
					invalidArticles.push(...articleExpired);
				}
				invalidArticles = invalidArticles.filter((val, idx, self) => self.indexOf(val) === idx);
				if(proAttributes.color_swatch != undefined && proAttributes.color_swatch[0] != undefined){
					try {var colorSwatch = JSON.parse(proAttributes.color_swatch[0]) } catch {var colorSwatch = '';}
						var swatchkeys = (Object.keys(colorSwatch).length === invalidArticles.length)
							? Object.keys(colorSwatch)
							: Object.keys(colorSwatch).filter(item => !invalidArticles.includes(item));
						var swatchlength = swatchkeys.length;
						for(var s=0;s<swatchlength; s++){
							var commase = ''; if(s != 0){ commase = ','; }
							allproducts += commase+swatchkeys[s].trim()+'_'+lowerCaseMarketId;
						}
				}
			//resultHtml += '			<button data-sizeguide="'+sizeguide+'" class="quickView hidden-xs" data-pid="'+productid+'" data-colorcode="'+colorcode+'" data-allproduct="'+allproducts+'" data-stylenumber="'+proAttributes.stylenumber_value[0]+'" data-sku="'+proAttributes.sku[0]+'" data-productkey="'+productkey+'" data-carturl="'+listCartUrl+'" data-mediabucketurl="'+media_bucket_url+'">'+$t("QUICK SHOP")+'</button>';
					resultHtml += '<button style="display: none" class="quickView hidden hidden-xs hidden-md hidden-lg hidden-sm" data-pid="'+productid+'" data-stylenumber="'+proAttributes.stylenumber_value[0]+'" data-sku="'+proAttributes.sku[0]+'" data-productkey="'+productkey+'"></button>';
					resultHtml += '			<div class="product details product-item-details">';
										var productMarker = '';
										var isEnvironment = false;
										if(proAttributes.collection != undefined && proAttributes.collection[0] != undefined && proAttributes.collection[0] != ''){
											let markerShow = true;
											if (proAttributes.collection[0].trim().toLowerCase() === 'conscious' || proAttributes.collection[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker = '<span>'+proAttributes.collection[0]+'</span> ';
											}
										}else if(proAttributes.designer_collection != undefined && proAttributes.designer_collection[0] != undefined && proAttributes.designer_collection[0] != ''){
											let markerShow = true;
											if (proAttributes.designer_collection[0].trim().toLowerCase() === 'conscious' || proAttributes.designer_collection[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker = '<span>'+proAttributes.designer_collection[0]+'</span> ';
											}
										}else if(proAttributes.quality != undefined && proAttributes.quality[0] != undefined && proAttributes.quality[0] != ''){
											let markerShow = true;
											if (proAttributes.quality[0].trim().toLowerCase() === 'conscious' || proAttributes.quality[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker += '<span>'+proAttributes.quality[0]+'</span> ';
											}
										}else if(proAttributes.feature != undefined && proAttributes.feature[0] != undefined && proAttributes.feature[0] != ''){
											let markerShow = true;
											if (proAttributes.feature[0].trim().toLowerCase() === 'conscious' || proAttributes.feature[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker = '<span>'+proAttributes.feature[0]+'</span> ';
											}
										}else if(proAttributes.environment != undefined && proAttributes.environment[0] != undefined && proAttributes.environment[0] != ''){
											let markerShow = true;
											if (proAttributes.environment[0].trim().toLowerCase() === 'conscious' || proAttributes.environment[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker = '<span style = "color:#007b5f">'+proAttributes.environment[0]+'</span> ';
											}
											isEnvironment = true;
										}
										var pathName = window.location.pathname.split('/');
										if (pathName[1] && $.inArray(pathName[1], ['id_id', 'id_en', 'th_en', 'th_th']) >= 0) {
											var storeCodes = pathName[1].toUpperCase().split('_');
											if (storeCodes[1] && storeCodes[1] != 'EN') {
												let markerName = 'product_marker_' + storeCodes[1];
												if (proAttributes[markerName]) {
													if (isEnvironment) {
														let markerShow = true;
														if (proAttributes[markerName][0].trim().toLowerCase() === 'conscious' || proAttributes[markerName][0].trim().toLowerCase() === 'conscious choice') {
															markerShow = false;
														}
														if (markerShow === true) {
															productMarker = '<span style="color:#007b5f">'+proAttributes[markerName][0]+'</span>';
														}
													} else {
														let markerShow = true;
														if (proAttributes[markerName][0].trim().toLowerCase() === 'conscious' || proAttributes[markerName][0].trim().toLowerCase() === 'conscious choice') {
															markerShow = false;
														}
														if (markerShow === true) {
															productMarker = '<span>' + proAttributes[markerName][0] + '</span>';
														}
													}
												}
											}
										}

										if(productMarker != undefined && productMarker != ''){
			resultHtml += '				<div class="marketing-marker">';
			resultHtml +=  				productMarker;

			resultHtml += '				</div>';
										}
										if (!(proAttributes.online_date != undefined && proAttributes.launch_date != undefined && isComingSoon(proAttributes.online_date, proAttributes.launch_date))){
		if (invalidArticles.length === Object.keys(colorSwatch).length) {
			resultHtml += '				<div class="plp-outofstack-label">';
			resultHtml +=  				'<label>'+$t("Out Of Stock")+'</label>';
			resultHtml += '				</div>';
									}
										}
			resultHtml += '				<strong class="product name product-item-name">';
			resultHtml += '					<a class="product-item-link" href="'+siteBaseUrlWithoutSlash+prourl+'"><span>'+proname+' </span> </a>';
			resultHtml += '				</strong>';
			resultHtml += '				<div class="price-box price-final_price" data-role="priceBox" data-product-id="'+productid+'" data-price-box="product-id-'+productid+'">';
			var spriceclass = '';
											if(proAttributes.special_price != undefined && proAttributes.is_on_sale != undefined && proAttributes.is_on_sale[0] == 'true'){
												spriceclass = 'hm-special-price';
			resultHtml += '					<span class="special-price">';
			resultHtml += '						<span class="price-container price-final_price tax weee">';
			resultHtml += '							<span class="price-label">'+$t("Special Price")+'</span>';
								var sprice = proAttributes.special_price[0];
								var specialprice = changePriceFormat(sprice);
			resultHtml += '							<span id="product-price-'+productid+'" data-price-amount="'+proAttributes.special_price[0]+'" data-price-type="finalPrice" class="price-wrapper "><span class="price" >'+currencySymbol+''+specialprice+'</span></span>';
			resultHtml += '						</span>';
			resultHtml += '					</span>';
											}
											if(proAttributes.price != undefined){
			resultHtml += '					<span class="old-price">';
			resultHtml += '						<span class="price-container price-final_price tax weee">';
			resultHtml += '							<span class="price-label">'+$t("Regular Price")+'</span>';
								var priceval = proAttributes.price[0];
								var pricevaldecimal = changePriceFormat(priceval);
			resultHtml += '							<span id="old-price-'+productid+'" data-price-amount="'+proAttributes.price[0]+'" data-price-type="oldPrice" class="price-wrapper "><span class="price '+spriceclass+'">'+currencySymbol+''+pricevaldecimal+'</span></span>';
			resultHtml += '						</span>';
			resultHtml += '					</span>';
											}
			resultHtml += '				</div>';

					if(proAttributes.color_swatch != undefined && proAttributes.color_swatch[0] != undefined){
						try {var colorSwatch = JSON.parse(proAttributes.color_swatch[0]) } catch { var colorSwatch = ''};
						var swatchkeys = (Object.keys(colorSwatch).length === invalidArticles.length)
							? Object.keys(colorSwatch)
							: Object.keys(colorSwatch).filter(item => !invalidArticles.includes(item));
						var swatchlength = swatchkeys.length;

			resultHtml += '				<div class="rgbdiv">';
			resultHtml += '						<ul class="list-swatches" data-swatches-total="'+swatchlength+'">';
						 var swloop = 4; if(swatchlength < swloop){ swloop = swatchlength; }
						for(var s=0;s<swloop; s++){
							var swatchkey = swatchkeys[s].trim();
							var swatchesvar = colorSwatch[swatchkey];
							var swcolor = '',swrgb = '', swurl = '';
							if(swatchesvar != undefined && swatchesvar.article_description != undefined){ swcolor = swatchesvar.article_description;  } if(swatchesvar != undefined && swatchesvar.rgb != undefined){ swrgb = swatchesvar.rgb; } if(swatchesvar != undefined && swatchesvar.url != undefined){ swurl = swatchesvar.url; }
			resultHtml += '							<li class="item"> <a href="'+site_base_url+swurl+'" class="swatch" style="background-color: '+swrgb+';" title="'+swcolor+'">'+swcolor+'</a> </li> ';
						}
			resultHtml += '						</ul>';
						if(swatchlength > swloop){
							var morecount = parseInt(swatchlength)-parseInt(swloop);
			resultHtml += '						<span class="more-swatches" aria-hidden="true">+'+morecount+'</span>';
						}

			resultHtml += '				</div>';
						if(proAttributes.is_new != undefined && proAttributes.is_new[0] !== undefined && proAttributes.is_new[0] !== '' && proAttributes.is_new[0] === 'true'){
							resultHtml += '<div class="new-arrivals">'+$t("New arrivals")+'</div>';
						}
						if (proAttributes.online_date != undefined && proAttributes.launch_date != undefined && isComingSoon(proAttributes.online_date, proAttributes.launch_date)) {
							resultHtml += '<div class="new-product">' + $('#coming-soon-text').val() + '</div>';
						}
					}
			resultHtml += '			</div>';
			resultHtml += '		</div>';
			resultHtml += '	</li>';
			
			impressionjson.push({
					id: proAttributes.sku[0],
					type: "simple",
					name: proname,
					category: categoryName,
					list: impressionlist,
					position: i-1,
					listPosition: i
				});
				
				}
			}
		if(impressionjson !== ""){
			window.dataLayer = window.dataLayer || {}; 
			var impressionpage = 'category.products.list';

			if($('.current_page_action').val() == 'catalogsearch_result_index'){
				impressionpage = 'search_result_list';
			}
			// dataLayer.push[impressionpage] = [impressionjson];
			dataLayer.push({'ecommerce': {'impressions' : [impressionjson]}});
		}
		return resultHtml;
	}
	function searchHeadingTemplateNoResult(response,searchString){
		var resultHtml = '';
		var site_base_url = $('.site_base_url').val();
		resultHtml += '<div class="section">';
		resultHtml += '		<h1 class="heading">'+$t('No matching items')+'</h1>';
		resultHtml += '	</div>';
		resultHtml += '	<div class="deck-text section">';
		resultHtml += '	<p> '+$t('Your search %1 did not match any results.').replace('%1', '"<strong>' + removeXss(searchString) + '"</strong>')+'</p>';
								var corrections = response.corrections;
								var correctionslength = response.corrections.length;
								if(correctionslength > 0){
		resultHtml += '	<p> '+$t('Search results for ')+'"<strong>'+corrections[0].text+'</strong>"</p>';

								}
								if(correctionslength > 1){
		resultHtml += ' <p>'+$t('Did you mean: ');
								}
								if(correctionslength > 0){
									for(var vari=0; vari < correctionslength; vari++){
									var andsymbol = ''; if(vari > 2){ andsymbol = ' Or '; }
									if(vari != 0){
		resultHtml += andsymbol+'"<a class="suggestion" href="'+site_base_url+'catalogsearch/result/?q='+corrections[vari].text+'">'+corrections[vari].text+'</a>"';
										}
									}
								}
								if(correctionslength > 1){
		resultHtml += '			?';
								}
		resultHtml += '	</p>';
		resultHtml += '</div>';
		return resultHtml;
	}

	var entityMap = {
		"&": "&amp;",
		"<": "&lt;",
		">": "&gt;",
		'"': '&quot;',
		"'": '&#39;',
		"/": '&#x2F;'
	};

	function escapeHtml(string) {
		return String(string).replace(/[&<>"'\/]/g, function (s) {
			return entityMap[s];
		});
	}

	function apptussearchFacetsTemplate(response, filtertype){
		var resultHtml = '';
		var site_base_url = $('.site_base_url').val();
		var apptus_filter_lists = $('.apptus_filter_lists').val();
			apptus_filter_lists = apptus_filter_lists.split(',');
		var urlStr = window.location.href;
		var paramUrls = urlStr.split('?');
		var baseurlCurrent = paramUrls[0];
		var searchPhrase = document.getElementById('search').value.trim();
		searchPhrase = removeScriptTag(searchPhrase);
		searchPhrase = escapeHtml(searchPhrase);
		if(response.facets.length > 0){
			if(response.facets[0].facetList.length > 0){
			var sortbyname = 'sort_by'
			if(filtertype == 2){
				sortbyname = 'sortby'
			}
		resultHtml += '<div data-role="ln_collapsible" class="filter-options-item allow" data-attribute="sortby" role="presentation" data-collapsible="true">';
		resultHtml += '	<div data-role="ln_title" class="filter-options-title" role="tab" aria-selected="false" aria-expanded="false" tabindex="0"><span>' + $t('Sort by') + '</span><div class="mfg-selected mfg_selected_sortby"></div></div>';


									if($('.current_page_action').val() == 'catalogsearch_result_index'){
										var mainurl = site_base_url+'catalogsearch/result/index/?q='+searchPhrase+'&';
									}else{
										var mainurl = baseurlCurrent+'/?';
									}
				if(filtertype == 1){
									var checkedclass = ''; var checkedattr = '';
									if(findUrlParamValue('sort_by', 'relevance')){ checkedclass = 'checkboxChecked'; checkedattr = 'checked="checked"'; }
									if(findUrlParamAvailable('sort_by') == false){ checkedattr = 'checked="checked"'; }

		resultHtml += '		<div data-role="ln_content" class="filter-options-content" role="tabpanel" aria-hidden="true" style="display: none;">';
		resultHtml += '			<ol class="items ln-items-colections ">';
		resultHtml += '				<li class="item"> <a data-class="sort_by_relevance" href="'+mainurl+'sort_by=relevance"> <input type="radio" class="layer-input-filter radiosortby '+checkedclass+' checkbox_sort_by_relevance" name="'+sortbyname+'" id="" value="relevance" '+checkedattr+'> <label class="" for="checkbox_sort_by_relevance"> <span class="checkbox-plus" ></span> <span class="filter_custom_name">'+$t('Recommended')+'</span> </label> </a> </li>';
		var checkedclassnew = ''; var checkedattrnew = '';
		if(findUrlParamValue('sort_by', 'is_new,desc')){ checkedclassnew = 'checkboxChecked'; checkedattrnew = 'checked="checked"'; }
		resultHtml += '				<li class="item"> <a data-class="sort_by_isnewdesc" href="'+mainurl+'sort_by=is_new,desc"> <input type="radio" class="layer-input-filter radiosortby '+checkedclassnew+' checkbox_sort_by_isnewdesc" name="'+sortbyname+'" id="" value="is_new,desc" '+checkedattrnew+'> <label class="" for="checkbox_sort_by_isnewdesc"> <span class="checkbox-plus" ></span> <span class="filter_custom_name">'+$t('Newest')+'</span> </label> </a> </li>';
		var checkedclassprias = ''; var checkedattrprias = '';
		if(findUrlParamValue('sort_by', 'price,asc')){ checkedclassprias = 'checkboxChecked'; checkedattrprias = 'checked="checked"'; }
		resultHtml += '				<li class="item"> <a data-class="sort_by_priceasc" href="'+mainurl+'sort_by=price,asc"> <input type="radio" class="layer-input-filter radiosortby '+checkedclassprias+' checkbox_sort_by_priceasc" name="'+sortbyname+'" id="" value="price,asc" '+checkedattrprias+'> <label class="" for="checkbox_sort_by_priceasc"> <span class="checkbox-plus" ></span> <span class="filter_custom_name">'+$t('Lowest price')+'</span> </label> </a> </li>';
		var checkedclassprids = ''; var checkedattrprids = '';
		if(findUrlParamValue('sort_by', 'price,desc')){ checkedclassprids = 'checkboxChecked'; checkedattrprids = 'checked="checked"'; }
		resultHtml += '				<li class="item"> <a data-class="sort_by_pricedesc" href="'+mainurl+'sort_by=price,desc"> <input type="radio" class="layer-input-filter radiosortby '+checkedclassprids+' checkbox_sort_by_pricedesc" name="'+sortbyname+'" id="" value="price,desc" '+checkedattrprids+'> <label class="" for="checkbox_sort_by_pricedesc"> <span class="checkbox-plus" ></span> <span class="filter_custom_name">'+$t('Highest price')+'</span> </label> </a> </li>';
		resultHtml += '			</ol>';
		resultHtml += '		</div>';
				}
				if(filtertype == 2){
					var checkedclass = ''; var checkedattr = '';
					if(findUrlParamValue('sort_by', 'relevance')){ checkedclass = 'selected'; checkedattr = 'checked="checked"'; }else{ checkedclass = 'undefined';  }
					if(findUrlParamAvailable('sort_by') == false){ checkedattr = 'checked="checked"';checkedclass = 'selected'; }
					resultHtml += '	<div data-role="ln_content" class="filter-options-content sort-by-content" role="tabpanel" aria-hidden="true" style="display: none;">';
					resultHtml += '	<a data-class="sort_by_relevance" href="'+mainurl+'sort_by=relevance" class="sort-by-list '+checkedclass+'" data-val="name"> <input type="radio" class="layer-input-filter radiosortby hidden checkbox_sort_by_relevance" name="'+sortbyname+'" id="" value="relevance" '+checkedattr+'><span></span> '+$t('Recommended')+'</a>';
					var checkedclassnew = ''; var checkedattrnew = '';
					if(findUrlParamValue('sort_by', 'is_new,desc')){ checkedclassnew = 'selected'; checkedattrnew = 'checked="checked"'; }else{ checkedclassnew = 'undefined';  }

					resultHtml += '	<a data-class="sort_by_isnewdesc" href="'+mainurl+'sort_by=is_new,desc" class="sort-by-list '+checkedclassnew+'" data-val="name"><input type="radio" class="layer-input-filter radiosortby hidden checkbox_sort_by_isnewdesc" name="'+sortbyname+'" id="" value="is_new,desc" '+checkedattrnew+'><span></span> '+$t('Newest')+'</a>';

					var checkedclassprias = ''; var checkedattrprias = '';
					if(findUrlParamValue('sort_by', 'price,asc')){ checkedclassprias = 'selected'; checkedattrprias = 'checked="checked"'; }else{ checkedclassprias = 'undefined';  }

					resultHtml += '	<a data-class="sort_by_priceasc" href="'+mainurl+'sort_by=price,asc" class="sort-by-list '+checkedclassprias+'" data-val="name"><input type="radio" class="layer-input-filter radiosortby hidden checkbox_sort_by_priceasc" name="'+sortbyname+'" id="" value="price,asc" '+checkedattrprias+'><span></span> '+$t('Lowest price')+'</a>';

					var checkedclassprids = ''; var checkedattrprids = '';
					if(findUrlParamValue('sort_by', 'price,desc')){ checkedclassprids = 'selected'; checkedattrprids = 'checked="checked"'; }else{ checkedclassprids = 'undefined';  }

					resultHtml += '	<a data-class="sort_by_pricedesc" href="'+mainurl+'sort_by=price,desc" class="sort-by-list  '+checkedclassprids+'" data-val="name"> <input type="radio" class="layer-input-filter radiosortby hidden checkbox_sort_by_pricedesc" name="'+sortbyname+'" id="" value="price,desc" '+checkedattrprids+'><span></span> '+$t('Highest price')+'</a>';
					resultHtml += '	</div>';
				}


		resultHtml += '	</div>';


				var facetLists = response.facets[0].facetList;
				var facetListslength = response.facets[0].facetList.length;
				for(var vari=0; vari < facetListslength; vari++){
					var lengthoffacets = facetLists[vari].values.length;
					if(jQuery.inArray(facetLists[vari].attribute, apptus_filter_lists) != -1 && lengthoffacets > 0) {
						var attributeName = facetLists[vari].attribute;
						if(facetLists[vari].attribute == 'color_filter'){attributeName = 'color';}
						if(facetLists[vari].attribute == 'descriptive_length'){attributeName = 'length';}
						if(facetLists[vari].attribute == 'presentation_product_type'){attributeName = 'product type';}
						attributeName = attributeName.charAt(0).toUpperCase() + attributeName.slice(1);
		resultHtml += '<div data-role="ln_collapsible" class="filter-options-item allow" data-attribute="'+facetLists[vari].attribute+'" role="presentation" data-collapsible="true">';
		resultHtml += '	<div data-role="ln_title" class="filter-options-title" role="tab" aria-selected="false" aria-expanded="false" tabindex="0"><span>'+ $t(attributeName)+'</span><div class="mfg-selected mfg_selected_'+facetLists[vari].attribute+'"></div></div>';
		resultHtml += '		<div data-role="ln_content" class="filter-options-content" role="tabpanel" aria-hidden="true" style="display: none;">';
		resultHtml += '			<ol class="items ln-items-colections ">';
						if(facetLists[vari].values != undefined){
							var facetvalues = facetLists[vari].values;
							var facetvalueslength = facetLists[vari].values.length;
								for(var v=0; v < facetvalueslength; v++){
									if(facetvalues[v].text != undefined && facetvalues[v].text != ''){
										var attributeTextVal = facetvalues[v].text;
										var attributeTextValsplit = '';
										if(facetLists[vari].attribute == 'color_filter'){
											attributeTextValsplit = attributeTextVal.split('_');
											attributeTextVal = attributeTextValsplit[0];
										}
										var removedspecialchrs = facetvalues[v].text;
										removedspecialchrs = removedspecialchrs.replace(/[^0-9a-zA-Z_]/g, "");
		resultHtml += '				<li class="item '+facetLists[vari].attribute+'_'+removedspecialchrs+'" data-class="'+facetLists[vari].attribute+'_'+removedspecialchrs+'">';

		if($('.current_page_action').val() == 'catalogsearch_result_index'){
				resultHtml += '				<a href="'+site_base_url+'catalogsearch/result/index/?'+facetLists[vari].attribute+'='+facetvalues[v].text.replace('#','')+'&amp;q='+searchPhrase+'" data-class="checkbox_'+facetLists[vari].attribute+'_'+removedspecialchrs+'">';
		}

		if($('.current_page_action').val() == 'catalog_category_view'){

			resultHtml += '				<a href="'+baseurlCurrent+'/?'+facetLists[vari].attribute+'='+facetvalues[v].text.replace('#','')+'" data-class="checkbox_'+facetLists[vari].attribute+'_'+removedspecialchrs+'">';

		}
										if(facetvalues[v].selected != undefined && facetvalues[v].selected != ''){
											var factvalueinput = facetvalues[v].text.replace(/&/g, "%26");
		resultHtml += '					<input type="checkbox" class="layer-input-filter checkboxChecked checkbox_'+facetLists[vari].attribute+'_'+removedspecialchrs+'" name="'+facetLists[vari].attribute+'" id="" value="'+factvalueinput.replace('#','')+'" checked="checked">';
										}else{
											var factvalueinput = facetvalues[v].text.replace(/&/g, "%26");
		resultHtml += '					<input type="checkbox" class="layer-input-filter checkbox_'+facetLists[vari].attribute+'_'+removedspecialchrs+'" name="'+facetLists[vari].attribute+'" value="'+factvalueinput.replace('#','')+'">';
										}
										var colorClassfilter = '';
										if(facetLists[vari].attribute == 'color_filter'){
											colorClassfilter = 'filtercolorclass';
										}
		resultHtml += '					<label class="'+colorClassfilter+'" for="checkbox_'+facetLists[vari].attribute+'_'+removedspecialchrs+'">';
		resultHtml += '					 <span class="checkbox-plus" ></span>';
		if(facetLists[vari].attribute == 'color_filter'){

		resultHtml += '					 <span class="checkbox-plus-box" style="background-color:#'+attributeTextValsplit[1]+';"></span>';
		}
		resultHtml += '						<span class="filter_custom_name">'+ $t(attributeTextVal.trim()) +'</span>';
		resultHtml += '							<span class="count">'+facetvalues[v].count+'</span>';
		resultHtml += '					  </label>';
		resultHtml += '					</a>';
		resultHtml += '				</li>';
									}
								}
						}
		resultHtml += '			</ol>';
		resultHtml += '		</div>';
		resultHtml += '	</div>';

					}
				}
			}
		}
		return resultHtml;
	}

	function categoryOverviewTemplate(response){
		var resultHtml = '';
		var urlStr = window.location.href;
		var paramUrls = urlStr.split('?');
		var baseurlCurrent = paramUrls[0];
		var searchquery = document.getElementById('search').value.trim();
		searchquery = removeScriptTag(searchquery);
		searchquery = escapeHtml(searchquery);
		var firstLevelCategory = ['kids','men','ladies','divided'];
		catCollection = _.values(catCollection);
		catCollection.sort(function (a, b) {
			return a['position'] - b['position'];
		})
		if(response.categoryOverview != undefined){
		var categoryTree = response.categoryOverview[0].categoryTree;
			if(categoryTree != undefined){
			var firstChild = categoryTree.subcategories;
			var firstChildLength = categoryTree.subcategories.length;
				resultHtml += '<div data-role="ln_collapsible" class="filter-options-item cloned-filter category-filter-options category-left-container" attribute="cat" style=""><div data-role="ln_content" class="filter-options-content"><ol class="items ln-items-cat ">';
				var totalcount = 0;
				if(response.searchHitsWithCount[0].count != undefined){
					totalcount = response.searchHitsWithCount[0].count;
				}
				resultHtml += ' <li class="item cat_10" data-class="cat_10">';
				resultHtml += '<a href="'+baseurlCurrent+'?q='+searchquery+'" class="allcategorylist">';
				resultHtml += ' <label for="checkbox_cat_10">';
				resultHtml += ' <span class="checkbox-plus"></span>';
				resultHtml += '<span class="filter_custom_name">'+$t('All')+'</span>';
				resultHtml += '<span class="count allCategoryCount">'+totalcount+'</span>';
				resultHtml += '</label>';
				resultHtml += '</a>';
				resultHtml += ' </li>';
				var salecount = 0;
				if(response.isonsale != undefined && response.isonsale[0].count != undefined){
					salecount = response.isonsale[0].count;
				}
				var firstChildName = '';
				var firstChildKeyfil = '';
				for (const key in catCollection){
					var index = firstChild.findIndex(obj => obj.key === catCollection[key].key);
					if (index > -1) {
						var firstproductCount = firstChild[index].productCount;
						var firstChildKey = firstChild[index].key;
						firstChildName = catCollection[key].name;
						firstChildKeyfil = firstChildKey.replace(/[^0-9a-zA-Z_]/g, "");
						if (catCollection[key].key != 'sale') {
							if (firstChild[index].productCount > 0) {

								resultHtml += ' <li class="item cat_1' + key + '" data-class="cat_1' + key + '">';
								resultHtml += '<a href="' + baseurlCurrent + '?q=' + searchquery + '">';
								resultHtml += '<input type="checkbox" class="layer-input-filter checkbox_cat_' + firstChildKeyfil + '" value="' + firstChildKey + '" name="cat" id="checkbox_cat_1' + key + '" style="display: none;">';
								resultHtml += ' <label for="checkbox_cat_1' + key + '">';
								resultHtml += ' <span class="checkbox-plus"></span>';
								resultHtml += '<span class="filter_custom_name">' + $t(firstChildName) + '</span>';
								resultHtml += '<span class="count">' + firstproductCount + '</span>';
								resultHtml += '</label>';
								resultHtml += '</a>';
								resultHtml += ' </li>';
							}
						}
					}
				}

				var indexSale = firstChild.findIndex(obj => obj.key === 'sale');
				if (indexSale > -1){
					var firstproductCount = firstChild[indexSale].productCount;
					var firstChildKey = firstChild[indexSale].key;
					var indexSaleKey = catCollection.findIndex(obj => obj.key ===  'sale');
					if (indexSaleKey > -1){
						firstChildName = catCollection[indexSaleKey].name;
					} else {
						firstChildName = firstChild[indexSale].displayName;
					}
					firstChildKeyfil = firstChildKey.replace(/[^0-9a-zA-Z_]/g, "");
					resultHtml += ' <li class="item toggle-list">';
					resultHtml += '<div class="toggle-list-item salecategorytree">';

					resultHtml += ' <button class="js-toggle-trigger toggle-button" aria-expanded="false" aria-controls="dropdown-sales" data-scroll-top="false">';
					resultHtml += '<span class="filter_custom_name">'+ $t(firstChildName) +'</span>';
					resultHtml += '<span class="count">'+salecount+'</span>';
					resultHtml += '</button>';

					if(response.isonsale != undefined && response.isonsale[1] != undefined && response.isonsale[1].categoryTree != undefined) {
						var saleCategoryTree = response.isonsale[1].categoryTree;
						if (saleCategoryTree != undefined) {
							var salesubcategories = saleCategoryTree.subcategories;
							var salesubcategorieslength = salesubcategories.length;
							resultHtml += '<div id="dropdown-sales" class="toggle-list-content js-toggle-list-content" aria-hidden="true">';
							resultHtml += '<ul class="dropdown-list">';
							for (const key in catCollection){
								var indexChild = salesubcategories.findIndex(obj => obj.key === catCollection[key].key);
								if (indexChild > -1 ){
									var saleproductCount = salesubcategories[indexChild].productCount;
									var saleChildKey = salesubcategories[indexChild].key;
									if (saleproductCount > 0) {
										var saleChildName = catCollection[key].name;
										var salefirstChildKeyfil = saleChildKey.replace(/[^0-9a-zA-Z_]/g, "");
										resultHtml += ' <li class="inputwrapper" data-class="cat_2' + indexChild + '">';
										resultHtml += '<a href="' + baseurlCurrent + '?q=' + searchquery + '">';
										resultHtml += '<input type="checkbox" class="layer-input-filter checkbox_cat_' + salefirstChildKeyfil + '" value="' + saleChildKey + '&is_on_sale=true" name="cat" id="checkbox_cat_2' + indexChild + '" style="display: none;">';
										resultHtml += ' <label for="checkbox_cat_2' + indexChild + '">';
										resultHtml += ' <span class="checkbox-plus"></span>';
										resultHtml += '<span class="filter_custom_name">' + $t(saleChildName) + '</span>';
										resultHtml += '<span class="count">' + saleproductCount + '</span>';
										resultHtml += '</label>';
										resultHtml += '</a>';
										resultHtml += ' </li>';
									}
								}
							}
							resultHtml += '<ul>';
							resultHtml += '<div>';
						}
					}
					resultHtml += '</div>';
					resultHtml += ' </li>';
				}

				resultHtml += '</ol></div></div>';
			}
		}
		return resultHtml;
	}

	function fallBackResultTemplate(response){
			var resultHtml = '';
			var media_bucket_url = $('.media_bucket_url').val();
			var site_base_url = $('.site_base_url').val();
			var siteBaseUrlWithoutSlash = site_base_url.slice(0,-1);
			if(response.products != undefined && response.products != '' && response.products.length > 0){
				var products = response.products;
				var productsCount = response.products.length;
				for(var i=0; i < productsCount; i++){
					var proAttributes = products[i].attributes;
					var pticket = products[i].ticket;
					var productid = ''; if(proAttributes.entity_id != undefined){ productid = proAttributes.entity_id[0]; }
					var article_number = ''; if(proAttributes.article_number != undefined){ article_number = proAttributes.article_number[0]; }
					var proname = ''; if(proAttributes.product_name != undefined){ proname = proAttributes.product_name[0]; }
					var pathName = window.location.pathname.split('/');
					if (pathName[1] && $.inArray(pathName[1], ['id_id', 'id_en', 'th_en', 'th_th'])) {
						var storeCodes = pathName[1].toUpperCase().split('_');
						if (storeCodes[1]) {
							let productName = 'product_name_' + storeCodes[1];
							if (proAttributes[productName]) {
								proname = proAttributes[productName][0];
							}
						}
					}
					var prourl = ''; if(proAttributes.url != undefined){ prourl = proAttributes.url[0]; }
					var stilllifemediumm = '';  var lookbookmdiumm = '';
					if(proAttributes.lookbook != undefined && proAttributes.lookbook[0] != undefined){
						lookbookmdiumm = proAttributes.lookbook[0];
					}

					if(proAttributes.image_url != undefined && proAttributes.image_url[0] != undefined){
						stilllifemediumm = proAttributes.image_url[0];
					}

			resultHtml += '		<div class="product-item"  onclick="api.notify.click(\''+pticket+'\')">';
			resultHtml += '		<div class="product-item-info">';
			resultHtml += '			<div class="product-img-wrapper">';

			resultHtml += '				<a href="'+siteBaseUrlWithoutSlash+prourl+'" class="product-item-photo" tabindex="-1" data-color="">';
			resultHtml += '					<span class="product-image-container" style="width:396px;">';
			resultHtml += '						<span class="product-image-wrapper" style="padding-bottom: 150%;">';
			resultHtml += '						<img style="display: block;" src="data:image/gif;base64,R0lGODlhAQABAIABAP///wAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" data-lazy="'+stilllifemediumm+'" height="594" width="396" class="product-image-photo">';
			resultHtml += '					     </span>';
			resultHtml += '					</span>';
			resultHtml += '				</a>';
				var dmyHmList = decodeURIComponent(myHmList).split(','); //decoded list
            wishlistClass = '';
            if(dmyHmList){
                $.each(dmyHmList,function(i,v){
                    if(productid == v || article_number == v){
                        wishlistClass = 'addedInWishlist';
                    }
                });
            }
			resultHtml += '				<a id="wishlist'+productid+'" href="#" class="action towishlist ajax-add-to-wishlist spwishlist'+productid+' '+wishlistClass+'" title="'+$t("Add to Wish List")+'" aria-label="'+$t("Add to Wish List")+'" rel="'+site_base_url+'specommerce/wishlist/add" rev="'+proAttributes.entity_id[0]+'" data-action="add-to-wishlist" role="button">';
			resultHtml += '						<span>'+$t("Add to Wish List")+'</span>';
			resultHtml += '				</a>';
			resultHtml += '			</div>';
									var colorfilter = '';
										if(proAttributes.color_filter != undefined && proAttributes.color_filter != ''){
											var color = proAttributes.color_filter[0].split('_');
											colorfilter = color[1];
										}

			resultHtml += '			<div class="product-item-details">';
										var productMarker = '';
										if(proAttributes.collection != undefined && proAttributes.collection[0] != undefined && proAttributes.collection[0] != ''){
											let markerShow = true;
											if (proAttributes.collection[0].trim().toLowerCase() === 'conscious' || proAttributes.collection[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker = '<span>'+proAttributes.collection[0]+'</span> ';
											}
										}else if(proAttributes.designer_collection != undefined && proAttributes.designer_collection[0] != undefined && proAttributes.designer_collection[0] != ''){
											let markerShow = true;
											if (proAttributes.designer_collection[0].trim().toLowerCase() === 'conscious' || proAttributes.designer_collection[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker = '<span>'+proAttributes.designer_collection[0]+'</span> ';
											}
										}else if(proAttributes.quality != undefined && proAttributes.quality[0] != undefined && proAttributes.quality[0] != ''){
											let markerShow = true;
											if (proAttributes.quality[0].trim().toLowerCase() === 'conscious' || proAttributes.quality[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker += '<span>'+proAttributes.quality[0]+'</span> ';
											}
										}else if(proAttributes.feature != undefined && proAttributes.feature[0] != undefined && proAttributes.feature[0] != ''){
											let markerShow = true;
											if (proAttributes.feature[0].trim().toLowerCase() === 'conscious' || proAttributes.feature[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker = '<span>'+proAttributes.feature[0]+'</span> ';
											}
										}else if(proAttributes.environment != undefined && proAttributes.environment[0] != undefined && proAttributes.environment[0] != ''){
											let markerShow = true;
											if (proAttributes.environment[0].trim().toLowerCase() === 'conscious' || proAttributes.environment[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker = '<span style = "color:#007b5f">'+proAttributes.environment[0]+'</span> ';
											}
										}

										if(productMarker != undefined && productMarker != ''){
			resultHtml += '				<div class="marketing-marker">';
			resultHtml +=  				productMarker;

			resultHtml += '				</div>';
										}
			resultHtml += '				<strong class="product-item-name">';
			resultHtml += '					<a class="product-item-link" href="'+siteBaseUrlWithoutSlash+prourl+'"><span>'+proname+' </span> </a>';
			resultHtml += '				</strong>';
			resultHtml += '				<div class="price-box price-final_price" data-role="priceBox" data-product-id="'+productid+'" data-price-box="product-id-'+productid+'">';
					var spriceclass = '';
											if(proAttributes.special_price != undefined && proAttributes.is_on_sale != undefined && proAttributes.is_on_sale[0] == 'true'){
											spriceclass = 'hm-special-price';
			resultHtml += '					<span class="special-price">';
			resultHtml += '						<span class="price-container price-final_price tax weee">';
			resultHtml += '							<span class="price-label">'+$t("Special Price")+'</span>';
									var sprice = proAttributes.special_price[0];
									var specialprice = changePriceFormat(sprice);
			resultHtml += '							<span id="product-price-'+productid+'" data-price-amount="'+proAttributes.special_price[0]+'" data-price-type="finalPrice" class="price-wrapper "><span class="price" >'+currencySymbol+''+specialprice+'</span></span>';
			resultHtml += '						</span>';
			resultHtml += '					</span>';
											}
											if(proAttributes.price != undefined){
			resultHtml += '					<span class="old-price">';
			resultHtml += '						<span class="price-container price-final_price tax weee">';
			resultHtml += '							<span class="price-label">'+$t("Regular Price")+'</span>';
									var priceval = proAttributes.price[0];
									var pricevaldecimal = changePriceFormat(priceval);
			resultHtml += '							<span id="old-price-'+productid+'" data-price-amount="'+proAttributes.price[0]+'" data-price-type="oldPrice" class="price-wrapper "><span class="price '+spriceclass+'">'+currencySymbol+''+pricevaldecimal+'</span></span>';
			resultHtml += '						</span>';
			resultHtml += '					</span>';
											}
			resultHtml += '				</div> ';

			let invalidArticles = [];
			if (proAttributes.article_out_of_stock !== undefined
				&& proAttributes.article_out_of_stock[0] !== undefined
				&& proAttributes.article_out_of_stock[0] !== ''
			) {
				let articleOos = proAttributes.article_out_of_stock[0].split('|');
				invalidArticles.push(...articleOos);
			}
			if (proAttributes.article_expired !== undefined
				&& proAttributes.article_expired[0] !== undefined
				&& proAttributes.article_expired[0] !== ''
			) {
				let articleExpired = proAttributes.article_expired[0].split('|');
				invalidArticles.push(...articleExpired);
			}
			invalidArticles = invalidArticles.filter((val, idx, self) => self.indexOf(val) === idx);
			if(proAttributes.color_swatch != undefined && proAttributes.color_swatch[0] != undefined){
				try {var colorSwatch = JSON.parse(proAttributes.color_swatch[0]) } catch {var colorSwatch = '';}
						var swatchkeys = (Object.keys(colorSwatch).length === invalidArticles.length)
							? Object.keys(colorSwatch)
							: Object.keys(colorSwatch).filter(item => !invalidArticles.includes(item));
						var swatchlength = swatchkeys.length;

			resultHtml += '				<div class="rgbdiv">';
			resultHtml += '						<ul class="list-swatches" data-swatches-total="'+swatchlength+'">';
						 var swloop = 4; if(swatchlength < swloop){ swloop = swatchlength; }
						for(var s=0;s<swloop; s++){
							var swatchkey = swatchkeys[s].trim();
							var swatchesvar = colorSwatch[swatchkey];
							var swcolor = '',swrgb = '', swurl = '';
							if(swatchesvar != undefined && swatchesvar.article_description != undefined){ swcolor = swatchesvar.article_description;  } if(swatchesvar != undefined && swatchesvar.rgb != undefined){ swrgb = swatchesvar.rgb; } if(swatchesvar != undefined && swatchesvar.url != undefined){ swurl = swatchesvar.url; }
			resultHtml += '							<li class="item"> <a href="'+site_base_url+swurl+'" class="swatch" style="background-color: '+swrgb+';" title="'+swcolor+'">'+swcolor+'</a> </li> ';
						}
			resultHtml += '						</ul>';
						if(swatchlength > swloop){
							var morecount = parseInt(swatchlength)-parseInt(swloop);
			resultHtml += '						<span class="more-swatches" aria-hidden="true">+'+morecount+'</span>';
						}
			resultHtml += '				</div>';
					}
					if(proAttributes.is_new != undefined && proAttributes.is_new[0] !== undefined && proAttributes.is_new[0] !== '' && proAttributes.is_new[0] === 'true'){
						resultHtml += '<div class="new-arrivals">'+$t("New arrivals")+'</div>';
					}
					if (proAttributes.online_date != undefined && proAttributes.launch_date != undefined && isComingSoon(proAttributes.online_date, proAttributes.launch_date)) {
						resultHtml += '<div class="new-product">' + $('#coming-soon-text').val() + '</div>';
					}
					resultHtml += '			</div>';
			resultHtml += '		</div>';
			resultHtml += '		</div>';
				}
			}

		return resultHtml;
	}

	function updateSlider(classs){
		$(classs).slick({
			dots: false,
			infinite: true,
			speed: 500,
			arrows: true,
			slidesToShow: 6,
			slidesToScroll: 6,
			autoplaySpeed: 2000,
			autoplay: false,
			lazyLoad: 'ondemand',
			responsive: [
				{
					breakpoint: 768,
					settings: {
						slidesToShow: 2,
						slidesToScroll: 2,
						infinite: true,
						arrows: false,
						dots: true
					}
				},
				{
					breakpoint: 1024,
					settings: {
						slidesToShow: 3,
						slidesToScroll: 3,
						infinite: true,
						arrows: false,
						dots: true
					}
				}
			]
		});
	}

	function apptusFallbackFewResults(){

		var fb = new api.utils.FilterBuilder();
		var filter = fb.attribute('market_id', $('.market_id').val());
		filter = filter.toString() + " AND (status:'true')";
		if ($('#hide-zero-price').val() == 1) {
			filter += " AND (NOT price:'0') AND (NOT special_price:'0')";
		}
		api.panel('/fallback-few-results', {
			market_id: $('.market_id').val(),
			presentation_attributes: 'article_number,online_date,retire_date,launch_date,customer_groups,color_swatch,product_key,product_name,color,size,fit,url,display_name,image_url,lookbook,sku,price,special_price,currency_symbol,rgb,product_marker,entity_id,color_filter,stylenumber_value,environment,color_code,collection,designer_collection,quality,feature,is_new,is_on_sale',
			filter: filter,
			window_first:1,
			window_last:12
		}).then(function(data) {
			//console.log(data.response);
			if($('.current_page_action').val() == 'catalogsearch_result_index' || $('.current_page_action').val() == 'catalog_category_view'){
				if(data.response.recommendBasedOnCustomer != undefined && data.response.recommendBasedOnCustomer[0] != undefined && data.response.recommendBasedOnCustomer[0].products != undefined && data.response.recommendBasedOnCustomer[0].products.length > 0){
				var templateResult = fallBackResultTemplate(data.response.recommendBasedOnCustomer[0]);
				if($('.selectedForYouResults').hasClass('slick-initialized')){
					$('.selectedForYouResults').removeClass('slick-initialized');
					$('.selectedForYouResults').removeClass('slick-slider');
					$('.selectedForYouResults').html('');
				}
				$('.selectedForYouResults').html(templateResult);
				$('body').addClass('plp-no-product');
				$('.block-searchselectedforyou-products .product-items').slick({
					dots: false,
					infinite: true,
					speed: 500,
					arrows: true,
					slidesToShow: 4,
					slidesToScroll: 4,
					autoplaySpeed: 2000,
					autoplay: false,
					lazyLoad: 'ondemand',
					responsive: [
						{
							breakpoint: 768,
							settings: {
								slidesToShow: 2,
								slidesToScroll: 2,
								infinite: true,
								arrows: false,
								dots: true
							}
						},
						{
							breakpoint: 1024,
							settings: {
								slidesToShow: 3,
								slidesToScroll: 3,
								infinite: true,
								arrows: false,
								dots: true
							}
						}
					]
				});
				$(".slick-next.slick-arrow").click();
				$("img.product-image-photo").lazyload();
				$('.no-result-search').css('display','block');
				addToWishlistBag();
				}
				setTimeout(function(){
				$('.block-searchselectedforyou-products .product-items').closest('.widget-container').removeClass('widget-loader');
				},500);
			}

		}).catch(function(data) {
			//console.log('Error: ', data);
		});
	}

	function apptusOthersAlsoBought(prodcutkey){

		var fb = new api.utils.FilterBuilder();
		var facet = new api.utils.Facet();
		var filter = fb.attribute('market_id', $('.market_id').val());
		var lowercaseMarketid = $('.market_id').val().toLowerCase();
		var allProdcuts = '';
		// all article number values
		if(articlesJson != undefined){
			var allProdcuts = articlesJson.replace('["','').replace('"]','');
		}
		filter = filter.toString() + " AND (status:'true')";
		if ($('#hide-zero-price').val() == 1) {
			filter += " AND (NOT price:'0') AND (NOT special_price:'0')";
		}
		api.panel('/product-details-page', {
			market_id: $('.market_id').val(),
			product_key: prodcutkey,
			all_products: allProdcuts,
			presentation_attributes: 'article_number,online_date,launch_date,retire_date,customer_groups,product_key,product_name,color,size,fit,url,display_name,image_url,lookbook,sku,price,special_price,currency_symbol,rgb,product_marker,entity_id,color_filter,stylenumber_value,environment,color_code,collection,designer_collection,quality,feature,color_swatch,is_new,is_on_sale',
			filter: filter,
			facets: facet.toString(),
			window_first:1,
			window_last:12
		}).then(function(data) {
			if(data.response.allProductsTinyInformation != undefined && data.response.allProductsTinyInformation[0] != undefined){
				allProductsTinyInformation = data.response.allProductsTinyInformation[0];
			}
			if(data.response.productInformation != undefined && data.response.productInformation[0] != undefined){
				productInformation = data.response.productInformation[0];
				//push aaptus notification
				var articlenumber = articlenumberValue+'_'+lowercaseMarketid;
				if(productInformation != undefined){
					if(productInformation.products != undefined && nextclick == false){
						var allProdcutsData = productInformation.products;
						var allProdcutsDatalength = allProdcutsData.length;
						for(var pro = 0;pro < allProdcutsDatalength; pro++){
							var product = allProdcutsData[pro];
							var productticket = product.ticket;
							var productkey = product.key;
							if(product.key != undefined && product.key == articlenumber){
								api.notify.click(productticket);
								nextclick = true;
								continue;
							}
						}
					}
				}
			}

			if(data.response.recommendBasedOnProduct != undefined && data.response.recommendBasedOnProduct[0] != undefined && data.response.recommendBasedOnProduct[0].products != undefined && data.response.recommendBasedOnProduct[0].products.length > 0){
				var templateResult = fallBackResultTemplate(data.response.recommendBasedOnProduct[0]);
				if($('.widget-othersalsobought-grid').hasClass('slick-initialized')){
					$('.widget-othersalsobought-grid').removeClass('slick-initialized');
					$('.widget-othersalsobought-grid').removeClass('slick-slider');
				}
				$('.widget-othersalsobought-grid').html('');
				$('.widget-othersalsobought-grid').html(templateResult);
				$('.block-othersalsobought-products .product-items').slick({
					dots: false,
					infinite: true,
					speed: 500,
					arrows: true,
					slidesToShow: 4,
					slidesToScroll: 4,
					autoplaySpeed: 2000,
					autoplay: false,
					lazyLoad: 'ondemand',
					responsive: [
						{
							breakpoint: 768,
							settings: {
								slidesToShow: 2,
								slidesToScroll: 2,
								infinite: true,
								arrows: false,
								dots: true
							}
						},
						{
							breakpoint: 1024,
							settings: {
								slidesToShow: 3,
								slidesToScroll: 3,
								infinite: true,
								arrows: false,
								dots: true
							}
						}
				  	]
				});
				$(".block-othersalsobought-products .slick-next.slick-arrow").click();
				$("img.product-image-photo").lazyload();
				$('.block-othersalsobought-products').css('display','block');
				addToWishlistBag();
			}
			setTimeout(function(){
			$('.block-othersalsobought-products .product-items').closest('.widget-container').removeClass('widget-loader');
			},500);
			/*STARTS Code for show slider after slick load completed*/
                        if($('.block-stylewith-products .slick-active').length) {
                            $('.block-stylewith-products .slick-active').click();
                        }
                        if($('.block-othersalsobought-products .slick-active').length) {
                            $('.block-othersalsobought-products .slick-active').click();
                        }
                        $('.pdp-widget-container').addClass('loaded');
			/*ENDS Code for show slider after slick load completed*/
		}).catch(function(data) {
			//console.log('Error: ', data);
		});
	}

	function apptusProductPageStyleWith(productkey){
		var fb = new api.utils.FilterBuilder();
		var filter = fb.attribute('market_id', $('.market_id').val());
		var productSku = $('.product.attribute.sku').children('.value').text().trim();
		var lowercaseMarketid = $('.market_id').val().toLowerCase();

		var filterstylewith = '';
		var andcondition = '';
		if(product_customer_groups != undefined && product_customer_groups != ''){
			filterstylewith += "customer_groups:'"+product_customer_groups+"'";
			andcondition = " AND ";
		}

		if(product_presentation_product_type != undefined && product_presentation_product_type != ''){
			filterstylewith += andcondition+"NOT presentation_product_type:'"+product_presentation_product_type+"'";
		}
		filter = filter.toString() + " AND (status:'true')";
		if ($('#hide-zero-price').val() == 1) {
			filter += " AND (NOT price:'0') AND (NOT special_price:'0')";
		}
		api.panel('/product-style-with', {
			market_id: $('.market_id').val(),
			product_key: productkey,
			filter_stylewith: filterstylewith,
			presentation_attributes: 'article_number,online_date, launch_date, retire_date, customer_groups,product_key,product_name,color,size,fit,url,display_name,image_url,lookbook,sku,price,special_price,currency_symbol,rgb,product_marker,entity_id,color_filter,stylenumber_value,environment,color_code,collection,designer_collection,quality,feature,color_swatch,is_new,is_on_sale',
			filter: filter,
			window_first:1,
			window_last:12
		}).then(function(data) {
			if(data.response.recommendBasedOnProduct != undefined && data.response.recommendBasedOnProduct[0] != undefined && data.response.recommendBasedOnProduct[0].products != undefined && data.response.recommendBasedOnProduct[0].products.length > 0){
				var templateResult = fallBackResultTemplate(data.response.recommendBasedOnProduct[0]);
				$('.widget-stylewith-grid').html(templateResult);
				$('.block-stylewith-products .product-items').slick({
					dots: false,
					infinite: true,
					speed: 500,
					arrows: true,
					slidesToShow: 4,
					slidesToScroll: 4,
					autoplaySpeed: 2000,
					autoplay: false,
					lazyLoad: 'ondemand',
					responsive: [
						{
							breakpoint: 768,
							settings: {
								slidesToShow: 2,
								slidesToScroll: 2,
								infinite: true,
								arrows: false,
								dots: true
							}
						},
						{
							breakpoint: 1024,
							settings: {
								slidesToShow: 3,
								slidesToScroll: 3,
								infinite: true,
								arrows: false,
								dots: true
							}
						}
					]
				});
				$(".block-stylewith-products .slick-next.slick-arrow").click();
				$("img.product-image-photo").lazyload();
				$('.block-stylewith-products').css('display','block');
				addToWishlistBag();
			}
			setTimeout(function(){
			$('.block-stylewith-products .product-items').closest('.widget-container').removeClass('widget-loader');
			},500);

		}).catch(function(data) {
			//console.log('Error: ', data);
		});
	}
	//apptus cart page feed display
	function cartPageResultTemplate(response){
			var resultHtml = '';
			var media_bucket_url = $('.media_bucket_url').val();
			var site_base_url = $('.site_base_url').val();
			var siteBaseUrlWithoutSlash = site_base_url.slice(0,-1);
			if(response.products != undefined && response.products != '' && response.products.length > 0){
				var products = response.products;
				var productsCount = response.products.length;
				for(var i=0; i < productsCount; i++){
					var proAttributes = products[i].attributes;
					var pticket = products[i].ticket;
					var productid = ''; if(proAttributes.entity_id != undefined){ productid = proAttributes.entity_id[0]; }
					var article_number = ''; if(proAttributes.article_number != undefined){ article_number = proAttributes.article_number[0]; }
					var proname = ''; if(proAttributes.product_name != undefined){ proname = proAttributes.product_name[0]; }
					var prourl = ''; if(proAttributes.url != undefined){ prourl = proAttributes.url[0]; }
					var stilllifemediumm = '';  var lookbookmdiumm = '';
					if(proAttributes.lookbook != undefined && proAttributes.lookbook[0] != undefined){
						lookbookmdiumm = proAttributes.lookbook[0];
					}

					if(proAttributes.image_url != undefined && proAttributes.image_url[0] != undefined){
						stilllifemediumm = proAttributes.image_url[0];
					}

			resultHtml += '		<div class="product-item"  onclick="api.notify.click(\''+pticket+'\')">';
			resultHtml += '		<div class="product-item-info">';
			resultHtml += '			<div class="product-img-wrapper">';

			resultHtml += '				<a href="'+siteBaseUrlWithoutSlash+prourl+'" class="product-item-photo" tabindex="-1" data-color="">';
			resultHtml += '					<span class="product-image-container" style="width:564px;">';
			resultHtml += '						<span class="product-image-wrapper" style="padding-bottom: 150%;">';
			resultHtml += '						<img style="display: block;" src="'+stilllifemediumm+'" data-lazy="'+stilllifemediumm+'" height="846" width="564" class="product-image-photo">';
			resultHtml += '					     </span>';
			resultHtml += '					</span>';
			resultHtml += '				</a>';
			var dmyHmList = decodeURIComponent(myHmList).split(','); //decoded list
            wishlistClass = '';
            if(dmyHmList){
                $.each(dmyHmList,function(i,v){
                    if(productid == v){
                        wishlistClass = 'addedInWishlist';
                    }
                });
            }
			resultHtml += '				<a id="wishlist'+productid+'" href="#" class="action towishlist ajax-add-to-wishlist spwishlist'+productid+' '+wishlistClass+'" title="'+$t("Add to Wish List")+'" aria-label="'+$t("Add to Wish List")+'" rel="'+site_base_url+'specommerce/wishlist/add" rev="'+proAttributes.entity_id[0]+'" data-action="add-to-wishlist" role="button">';
			resultHtml += '						<span>'+$t("Add to Wish List")+'</span>';
			resultHtml += '				</a>';
			resultHtml += '			</div>';
									var colorfilter = '';
										if(proAttributes.color_filter != undefined && proAttributes.color_filter != ''){
											var color = proAttributes.color_filter[0].split('_');
											colorfilter = color[1];
										}

			resultHtml += '			<div class="product-item-details">';
										var productMarker = '';
										if(proAttributes.collection != undefined && proAttributes.collection[0] != undefined && proAttributes.collection[0] != ''){
											let markerShow = true;
											if (proAttributes.collection[0].trim().toLowerCase() === 'conscious' || proAttributes.collection[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker = '<span>'+proAttributes.collection[0]+'</span> ';
											}
										}else if(proAttributes.designer_collection != undefined && proAttributes.designer_collection[0] != undefined && proAttributes.designer_collection[0] != ''){
											let markerShow = true;
											if (proAttributes.designer_collection[0].trim().toLowerCase() === 'conscious' || proAttributes.designer_collection[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker = '<span>'+proAttributes.designer_collection[0]+'</span> ';
											}
										}else if(proAttributes.quality != undefined && proAttributes.quality[0] != undefined && proAttributes.quality[0] != ''){
											let markerShow = true;
											if (proAttributes.quality[0].trim().toLowerCase() === 'conscious' || proAttributes.quality[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker += '<span>'+proAttributes.quality[0]+'</span> ';
											}
										}else if(proAttributes.feature != undefined && proAttributes.feature[0] != undefined && proAttributes.feature[0] != ''){
											let markerShow = true;
											if (proAttributes.feature[0].trim().toLowerCase() === 'conscious' || proAttributes.feature[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker = '<span>'+proAttributes.feature[0]+'</span> ';
											}
										}else if(proAttributes.environment != undefined && proAttributes.environment[0] != undefined && proAttributes.environment[0] != ''){
											let markerShow = true;
											if (proAttributes.environment[0].trim().toLowerCase() === 'conscious' || proAttributes.environment[0].trim().toLowerCase() === 'conscious choice') {
												markerShow = false;
											}
											if (markerShow === true) {
												productMarker = '<span style = "color:#007b5f">'+proAttributes.environment[0]+'</span> ';
											}
										}

										if(productMarker != undefined && productMarker != ''){
			resultHtml += '				<div class="marketing-marker">';
			resultHtml +=  				productMarker;

			resultHtml += '				</div>';
										}
			resultHtml += '				<strong class="product-item-name">';
			resultHtml += '					<a class="product-item-link" href="'+siteBaseUrlWithoutSlash+prourl+'"><span>'+proname+' </span> </a>';
			resultHtml += '				</strong>';
			resultHtml += '				<div class="price-box price-final_price" data-role="priceBox" data-product-id="'+productid+'" data-price-box="product-id-'+productid+'">';
			var spriceclass = '';
											if(proAttributes.special_price != undefined && proAttributes.is_on_sale != undefined && proAttributes.is_on_sale[0] == 'true'){
											spriceclass = 'hm-special-price';
			resultHtml += '					<span class="special-price">';
			resultHtml += '						<span class="price-container price-final_price tax weee">';
			resultHtml += '							<span class="price-label">'+$t("Special Price")+'</span>';
								var sprice = proAttributes.special_price[0];
								var specialprice = changePriceFormat(sprice);
			resultHtml += '							<span id="product-price-'+productid+'" data-price-amount="'+proAttributes.special_price[0]+'" data-price-type="finalPrice" class="price-wrapper "><span class="price" >'+currencySymbol+''+specialprice+'</span></span>';
			resultHtml += '						</span>';
			resultHtml += '					</span>';
											}
											if(proAttributes.price != undefined){
			resultHtml += '					<span class="old-price">';
			resultHtml += '						<span class="price-container price-final_price tax weee">';
			resultHtml += '							<span class="price-label">'+$t("Regular Price")+'</span>';
								var priceval = proAttributes.price[0];
								var pricevaldecimal = changePriceFormat(priceval);
			resultHtml += '							<span id="old-price-'+productid+'" data-price-amount="'+proAttributes.price[0]+'" data-price-type="oldPrice" class="price-wrapper "><span class="price '+spriceclass+'">'+currencySymbol+''+pricevaldecimal+'</span></span>';
			resultHtml += '						</span>';
			resultHtml += '					</span>';
											}
			resultHtml += '				</div>        ';

			let invalidArticles = [];
			if (proAttributes.article_out_of_stock !== undefined
				&& proAttributes.article_out_of_stock[0] !== undefined
				&& proAttributes.article_out_of_stock[0] !== ''
			) {
				let articleOos = proAttributes.article_out_of_stock[0].split('|');
				invalidArticles.push(...articleOos);
			}
			if (proAttributes.article_expired !== undefined
				&& proAttributes.article_expired[0] !== undefined
				&& proAttributes.article_expired[0] !== ''
			) {
				let articleExpired = proAttributes.article_expired[0].split('|');
				invalidArticles.push(...articleExpired);
			}
			invalidArticles = invalidArticles.filter((val, idx, self) => self.indexOf(val) === idx);
			if(proAttributes.color_swatch != undefined && proAttributes.color_swatch[0] != undefined){
						var colorSwatch = JSON.parse(proAttributes.color_swatch[0]);
						var swatchkeys = (Object.keys(colorSwatch).length === invalidArticles.length)
							? Object.keys(colorSwatch)
							: Object.keys(colorSwatch).filter(item => !invalidArticles.includes(item));
						var swatchlength = swatchkeys.length;

			resultHtml += '				<div class="rgbdiv">';
			resultHtml += '						<ul class="list-swatches" data-swatches-total="'+swatchlength+'">';
						 var swloop = 4; if(swatchlength < swloop){ swloop = swatchlength; }
						for(var s=0;s<swloop; s++){
							var swatchkey = swatchkeys[s].trim();
							var swatchesvar = colorSwatch[swatchkey];
							var swcolor = '',swrgb = '', swurl = '';
							if(swatchesvar != undefined && swatchesvar.article_description != undefined){ swcolor = swatchesvar.article_description;  } if(swatchesvar != undefined && swatchesvar.rgb != undefined){ swrgb = swatchesvar.rgb; } if(swatchesvar != undefined && swatchesvar.url != undefined){ swurl = swatchesvar.url; }
			resultHtml += '							<li class="item"> <a href="'+site_base_url+swurl+'" class="swatch" style="background-color: '+swrgb+';" title="'+swcolor+'">'+swcolor+'</a> </li> ';
						}
			resultHtml += '						</ul>';
						if(swatchlength > swloop){
							var morecount = parseInt(swatchlength)-parseInt(swloop);
			resultHtml += '						<span class="more-swatches" aria-hidden="true">+'+morecount+'</span>';
						}

			resultHtml += '				</div>';
					}
					if(proAttributes.is_new != undefined && proAttributes.is_new[0] !== undefined && proAttributes.is_new[0] !== '' && proAttributes.is_new[0] === 'true'){
						resultHtml += '<div class="new-arrivals">'+$t("New arrivals")+'</div>';
					}

			resultHtml += '			</div>';
			resultHtml += '		</div>';
			resultHtml += '		</div>';

				}
			}

		return resultHtml;
	}

	function apptusCartYoumayalsoAndPopular(){
		var fb = new api.utils.FilterBuilder();
		var facet = new api.utils.Facet();
		var filter = fb.attribute('market_id', $('.market_id').val());
		var productSku = $('.product.attribute.sku').children('.value').text().trim();
		var lowercaseMarketid = $('.market_id').val().toLowerCase();
		var articlenumber = '';
		$('#shopping-cart-table .item-options').each(function (index, element) {
			var number = $(this).children('dd').first().text().trim();
			var commaseprate = ',';
			if(index == 0){ commaseprate = ''; }
			articlenumber += commaseprate+number.replace(',','')+'_'+lowercaseMarketid;
		});
		filter = filter.toString() + " AND (status:'true')";
		if ($('#hide-zero-price').val() == 1) {
			filter += " AND (NOT price:'0') AND (NOT special_price:'0')";
		}
		api.panel('/cart-page', {
			market_id: $('.market_id').val(),
			cart: "'"+articlenumber+"'",
			presentation_attributes: 'article_number,customer_groups,product_key,product_name,color,size,fit,url,display_name,image_url,lookbook,sku,price,special_price,currency_symbol,rgb,product_marker,entity_id,color_filter,stylenumber_value,environment,color_code,collection,designer_collection,quality,feature,color_swatch,is_new,is_on_sale',
			filter: filter,
			facets: facet.toString(),
			window_first:1,
			window_last:12
		}).then(function(data) {
			if(data.response.topSellers != undefined && data.response.topSellers[0] != undefined && data.response.topSellers[0].products != undefined && data.response.topSellers[0].products.length > 0){
				var templateResult = cartPageResultTemplate(data.response.topSellers[0]);
				$('.widget-bestseller-grid').html(templateResult);
				updateSlider('.block-bestseller-products .product-items');
				$(".slick-next.slick-arrow").click();
				$("img.product-image-photo").lazyload();
				$('.block-bestseller-products').css('display','block');
				addToWishlistBag();
			}

			if(data.response.recommendBasedOnCart != undefined && data.response.recommendBasedOnCart[0] != undefined && data.response.recommendBasedOnCart[0].products != undefined && data.response.recommendBasedOnCart[0].products.length > 0){
				var templateResult = cartPageResultTemplate(data.response.recommendBasedOnCart[0]);
				$('.widget-youmayalsolike-grid').html(templateResult);
				updateSlider('.block-youmayalsolike-products .product-items');
				$(".slick-next.slick-arrow").click();
				$("img.product-image-photo").lazyload();
				$('.block-youmayalsolike-products').css('display','block');
				addToWishlistBag();
			}
			setTimeout(function(){
				$('.block-bestseller-products .product-items').closest('.widget-container').removeClass('widget-loader');
				$('.block-youmayalsolike-products .product-items').closest('.widget-container').removeClass('widget-loader');
			},500);
                        /*STARTS Code for show slider after slick load completed*/
                        if($('.block-bestseller-products .slick-active').length) {
                            $('.block-bestseller-products .slick-active').click();
                        }
                        if($('.block-youmayalsolike-products .slick-active').length) {
                            $('.block-youmayalsolike-products .slick-active').click();
                        }
                        $('.cart-widget-container').addClass('loaded');
			/*ENDS Code for show slider after slick load completed*/

		}).catch(function(data) {
			//console.log('Error: ', data);
		});
	}

	function plpYouMayAlsoLike(response){
		if (isShowMore === false) {
			if (response != undefined && response.products.length > 0) {
				var templateResult = fallBackResultTemplate(response);
				$('.plp-widget-youmayalsolike-grid').html(templateResult);
				$('.plp-block-youmayalsolike-products .product-items').slick({
					dots: false,
					infinite: true,
					speed: 500,
					arrows: true,
					slidesToShow: 4,
					slidesToScroll: 4,
					autoplaySpeed: 2000,
					autoplay: false,
					lazyLoad: 'ondemand',
					responsive: [
						{
							breakpoint: 768,
							settings: {
								slidesToShow: 2,
								slidesToScroll: 2,
								infinite: true,
								arrows: false,
							}
						},
						{
							breakpoint: 1024,
							settings: {
								slidesToShow: 3,
								slidesToScroll: 3,
								infinite: true,
								arrows: false,
							}
						}
					]
				});
				$("img.product-image-photo").lazyload();
				$('.plp-block-youmayalsolike-products').css('display', 'block');
				addToWishlistBag();
			}
			setTimeout(function () {
				$(".slick-next.slick-arrow").click();
				$('.plp-block-youmayalsolike-products .product-items').closest('.widget-container').removeClass('widget-loader');
			}, 500);
		} else {
			$('.slick-next.slick-arrow').click();
		}
	}

	function findInArryValue(array, value){
		var returnvalue = false;
		for(var c=0;c < array.length;c++){
			if(array[c] == value){
				returnvalue = true;
			}
		}
		return returnvalue;
	}

	function loadApptusDataSearch(windowfirst, windowlast, type, apiurl, didyoumean, research){
		// Prevent auto scroll when back off browser
		if ('scrollRestoration' in history) {
			history.scrollRestoration = 'manual';
		}

		if (performance.navigation.type == performance.navigation.TYPE_RELOAD) {
			if ($.cookie('list-page-offset')) {
				document.cookie = "list-page-offset=; path=/";
				document.cookie = "list-page-offset-url=; path=/";
			}
		}

		var fb = new api.utils.FilterBuilder();
		var facet = new api.utils.Facet();
		//var filter = fb.attribute('market_id', $('.market_id').val());
		var filter = "market_id:'"+$('.market_id').val()+"' AND (status:'true') ";

		var sortby = '';
		var urlparams = '';
		var selectedCategory = 'root'
		var searchPhrase = '';
		var argumentsLists = '';
		var andsymbol = '&';
		var today = getTodayDate();
		//------------------
			var parser = document.createElement('a');
			parser.href = window.location.href;
			var query = parser.search.substring(1);
			var vars = query.split('&');
			for (var i = 0; i < vars.length; i++) {
				var pair = vars[i].split('=');
				if(pair[0] != 'q' && pair[0] != 'sort_by' && pair[0] != 'cat' && pair[0] != 'offset' && research != 1 && pair[0].indexOf('utm_')==-1 && pair[0].indexOf('_atrk_')==-1 && pair[0].indexOf('gclid')==-1 && pair[0].indexOf('fbclid')==-1){
					if(pair[0] != "" && pair[1] != ""){
						if(pair[0] != undefined && pair[1] != undefined){
							var attrArrays = pair[1].split(',');
							var lengthArray = attrArrays.length;
							for (var l = 0; l <= lengthArray; l++) {
								if(attrArrays[l] != undefined){
									var decoded = attrArrays[l].replace(/%20/g, " ");
									decoded = decoded.replace(/%26/g, "&");
									facet.add(pair[0], decoded);
								}
							}
							urlparams += andsymbol+vars[i];
						}
					}
				}else{
					if(pair[0] != 'q'){
						urlparams += andsymbol+vars[i];
					}
				}
				if(pair[0] == 'sort_by'){
					sortby = pair[1].replace(',', ' ');
				}
				if(pair[0] == 'cat'){
					selectedCategory = pair[1];
				}
			}
		if(sortby != ''){
			sortby = sortby+', relevance';
		}else{
			sortby = 'relevance';
		}
		//---------------

		var lowercaseMarketid = $('.market_id').val().toLowerCase();
		if($('.current_page_action').val() == 'catalog_category_view'){
			//selectedCategory = "section_"+$('.market_id').val()+":'"+$('.current_category_path').val()+"'";
			var windowpathname = window.location.href.replace(window.location.origin+'/', "");
			var categoriespath = windowpathname.replace('.html','');
			var categoryAfterSplit = categoriespath.split('?');
			if(categoryAfterSplit[1] != undefined){
				var categoryArray = categoryAfterSplit[0].split('/');
			}else{
				var categoryArray = categoriespath.split('/');
			}
			if (categoryArray.length > 1) {
				if ($.inArray(categoryArray[0], ['th_th', 'th_en', 'id_id', 'id_en']) >= 0) {
					categoryArray.shift();
				}
			}
			var categoryLength = categoryArray.length;
			var apptusUrlKey = 'root';
			var availOptions = ["1","ladies", "kids", "men", "divided"];
			var availOptionsSecond = JSON.parse($('.apptus_second_level_options').val());
			var shopByConceptCategory = $('.shop_byconcept_products').val();
			var configCategory = JSON.parse(shopByConceptCategory);

			if(categoryLength > 2){
				var levelOneCategory = categoryArray[0].trim();
				var leveltwoCategory = categoryArray[1].trim();
				var levelthreeCategory = categoryArray[2].trim();
				var nthlevelCategory = '';
				if(categoryArray[3] != undefined){
					nthlevelCategory += '-'+categoryArray[3].trim();
				}
				if(categoryArray[4] != undefined){
					nthlevelCategory += '-'+categoryArray[4].trim();
				}

				if (leveltwoCategory
					&& (leveltwoCategory == 'shop-by-product' || leveltwoCategory == 'shop-by-concept')
				) {
					filter += "AND (is_on_sale:'false') AND (product_is_in_stock:'true') ";
				}

				if(levelthreeCategory && levelthreeCategory == 'view-all'){
					if(leveltwoCategory && leveltwoCategory == 'shop-by-product'){
						if(levelOneCategory == 'divided'){
							if(singleCategoryApptus != undefined && singleCategoryApptus != ''){
								filter += singleCategoryApptus;
							}else{
								filter += "AND (concept:'Divided')";
							}
						}else{
							apptusUrlKey =  categoryArray[0]+"-"+leveltwoCategory;
						}
					}else if(jQuery.inArray(leveltwoCategory, availOptions)){
						if(leveltwoCategory == 'divided'){
							apptusUrlKey =  'root';
							if(singleCategoryApptus != undefined && singleCategoryApptus != ''){
								filter += singleCategoryApptus;
							}else{
								filter += "AND (concept:'Divided') AND (is_on_sale:'true')";
							}
						}else{
							apptusUrlKey = leveltwoCategory+"-shop-by-product";
							filter += "AND (is_on_sale:'true')";
						}
					}
				}else if(leveltwoCategory && leveltwoCategory == 'shop-by-concept'){
					if(jQuery.inArray(levelOneCategory, availOptions)){
						apptusUrlKey = levelOneCategory+"-shop-by-product";
						var conceptVal = currentCategoryEnName.trim().toLowerCase();
						filter += "AND (concept:'"+conceptVal.charAt(0).toUpperCase() + conceptVal.slice(1)+"')";
					}
				}else if(findInArryValue(availOptions, leveltwoCategory)){
					var shopbyconcept = configCategory[leveltwoCategory];
					var conceptArray = [];
					if(shopbyconcept != undefined){
						conceptArray = shopbyconcept.split('|');
						if(findInArryValue(conceptArray, levelthreeCategory) == true){
							apptusUrlKey = leveltwoCategory+"-shop-by-product";
							var conceptVal = currentCategoryEnName.trim().toLowerCase();
							filter += "AND (is_on_sale:'true') AND (concept:'"+conceptVal.charAt(0).toUpperCase() + conceptVal.slice(1)+"')";
						}else{
							var leveltwoCategoryOne = 'shop-by-product';
							var currentalllevelcategory = leveltwoCategory+'-'+leveltwoCategoryOne+'-'+levelthreeCategory;
							apptusUrlKey = currentalllevelcategory;
							filter += "AND (is_on_sale:'true')";
						}
					}
				}else if(findInArryValue(availOptionsSecond, leveltwoCategory) == true){
					if(jQuery.inArray(levelOneCategory, availOptions)){
						if(singleCategoryApptus != undefined && singleCategoryApptus != ''){
							filter += singleCategoryApptus;
						}else{
							var currentalllevelcategory = levelOneCategory+'-'+leveltwoCategory+'-'+levelthreeCategory+nthlevelCategory;
							apptusUrlKey = currentalllevelcategory;
						}
					}
				}else if(levelOneCategory && levelOneCategory == 'divided'){
					if(jQuery.inArray(levelOneCategory, availOptions)){
						if(singleCategoryApptus != undefined && singleCategoryApptus != ''){
							filter += singleCategoryApptus;
						}else{
							var currentalllevelcategory = levelOneCategory+'-'+leveltwoCategory+'-'+levelthreeCategory+nthlevelCategory;
							apptusUrlKey = currentalllevelcategory;
						}
					}
				}else{
					var currentalllevelcategory = levelOneCategory+'-'+leveltwoCategory+'-'+levelthreeCategory+nthlevelCategory;
					apptusUrlKey = currentalllevelcategory;
				}
			}

			selectedCategory = apptusUrlKey;
			filter = filter.toString();
			if ($('#hide-zero-price').val() == 1) {
				filter += " AND (NOT price:'0') AND (NOT special_price:'0')";
			}
			argumentsLists = {
				search_phrase: searchPhrase,
				selected_category: "section_"+lowercaseMarketid+":'"+selectedCategory+"'",
				market_id: $('.market_id').val(),
				presentation_attributes: 'article_number,online_date,retire_date,launch_date,product_is_in_stock,customer_groups,product_key,product_name,product_name_TH,product_name_ID,product_marker_TH,product_marker_ID,color,size,fit,url,display_name,image_url,lookbook,sku,price,special_price,currency_symbol,rgb,product_marker,entity_id,color_filter,stylenumber_value,environment,color_code,collection,designer_collection,quality,feature,color_swatch,is_new,is_on_sale,article_out_of_stock,article_expired',
				window_first: windowfirst,
				window_last: windowlast,
				today: today,
				root_category:"section_"+lowercaseMarketid+":'root'",
				sort_by: sortby,
				filter: filter,
				facets: facet.toString()
			};
		}
		if($('.current_page_action').val() == 'catalogsearch_result_index'){
			searchPhrase = apptusSearchPhrase = document.getElementById('search').value.trim();
			searchPhrase = removeScriptTag(searchPhrase);
			searchPhrase = escapeHtml(searchPhrase);
			if(didyoumean != null){
				searchPhrase = didyoumean;
			}
			filter = filter.toString();
			if ($('#hide-zero-price').val() == 1) {
				filter += " AND (NOT price:'0') AND (NOT special_price:'0')";
			}
			argumentsLists = {
				search_phrase: apptusSearchPhrase,
				market_id: $('.market_id').val(),
				selected_category: "section_"+lowercaseMarketid+":'"+selectedCategory+"'",
				presentation_attributes: 'article_number,online_date,retire_date,launch_date,product_is_in_stock,customer_groups,product_key,product_name,product_name_TH,product_name_ID,product_marker_TH,product_marker_ID,color,size,fit,url,display_name,image_url,lookbook,sku,price,special_price,currency_symbol,rgb,product_marker,entity_id,color_filter,stylenumber_value,environment,color_code,collection,designer_collection,quality,feature,color_swatch,is_new,is_on_sale,article_out_of_stock,article_expired',
				window_first: windowfirst,
				today: today,
				root_category:"section_"+lowercaseMarketid+":'root'",
				window_last: windowlast,
				sort_by: sortby,
				filter: filter,
				facets: facet.toString()
			};
		}
	
		// api call
		api.panel(apiurl, argumentsLists).then(function(data) {
			var searchVal = {searchPhrase: searchPhrase};
			
			if($('.current_page_action').val() == 'catalog_category_view'){
				var templateResult = ''
				if(data.response.productListWithCount[0].count != null && data.response.productListWithCount[0].count != undefined && data.response.productListWithCount[0].count > 0){
					templateResult = searchTemplate(data.response.productListWithCount[1], levelOneCategory, levelthreeCategory);
					searchHitsWithCount = data.response.productListWithCount[1];
				}else{
					templateResult = '';
					//apptusFallbackFewResults();
				}
				if(type == 2){
					$('#apptussearchResults').append(templateResult);
				}else{
					$('#apptussearchResults').html(templateResult);
				}
			}
			if($('.current_page_action').val() == 'catalogsearch_result_index'){
				if(data.response.searchHitsWithCount[0].count != null && data.response.searchHitsWithCount[0].count != undefined && data.response.searchHitsWithCount[0].count > 0){
					if(didyoumean == null){
						$('.page-title-wrapper').html('<h1 class="page-title" style="display:block;"><span class="base" data-ui-id="page-title-wrapper">'+$t('SHOWING RESULTS FOR')+' "'+removeXss(searchPhrase)+'"</span></h1>');
					}
					var templateResult = searchTemplate(data.response.searchHitsWithCount[1], levelOneCategory, levelthreeCategory);
					searchHitsWithCount = data.response.searchHitsWithCount[1];
				}else{
					if(didyoumean == null){
						var headingresult = searchHeadingTemplateNoResult(data.response.didYouMean[0],searchPhrase);
						$('.page-title-wrapper').html(headingresult);
					}
					var templateResult = '';
				}
				
				if(type == 2){
					$('#apptussearchResults').append(templateResult);
				}else{
					$('#apptussearchResults').html(templateResult);
				}
			}
			$("img.lazy").lazyload();
			var displayingcount = windowlast;
			var toolbartotalcount = 0;
			if($('.current_page_action').val() == 'catalogsearch_result_index'){
				toolbartotalcount = data.response.searchHitsWithCount[0].count;
				//results not found call didyou mean search
				if(toolbartotalcount == 0){
					if(data.response.didYouMean[0].corrections != undefined && data.response.didYouMean[0].corrections.length > 0){
						var didYouMean = data.response.didYouMean[0].corrections[0].text;
						// change url
						if(didYouMean != null && didYouMean != ''){
							var urlStr = window.location.href;
							var paramUrls = urlStr.split('?');
							var baseurlSearch = paramUrls[0];
							document.getElementById('search').value = didYouMean;
							baseurlSearch = baseurlSearch+'?q='+didYouMean;
							window.history.pushState({url: baseurlSearch}, '', baseurlSearch);
						
							var lastdata = $('.search_page_first_loadingcount').val();
							loadUrl = '/search-result';
							loadApptusDataSearch(1, lastdata, 1, loadUrl, didYouMean, null);
							return false;
						}else{
							apptusFallbackFewResults();
						}
					}else{
						apptusFallbackFewResults();
					}
				}
				if(data.response.searchHitsWithCount[0].count < displayingcount){
					 displayingcount = data.response.searchHitsWithCount[0].count;
				}
				if(didyoumean == null){
					// change url
					var urlStr = window.location.href;
					var paramUrls = urlStr.split('?');
					var baseurlSearch = paramUrls[0];
					var searchquery = document.getElementById('search').value.trim();
					searchquery = removeScriptTag(searchquery);
					if(research != null && research != '' && research == 1){
						baseurlSearch = baseurlSearch+'?q='+searchquery;
					}else{
						baseurlSearch = baseurlSearch+'?q='+searchquery+urlparams;
					}
					window.history.pushState({url: baseurlSearch}, '', baseurlSearch);
				}
			}
			if($('.current_page_action').val() == 'catalog_category_view'){
				toolbartotalcount = data.response.productListWithCount[0].count;
				if(data.response.productListWithCount[0].count < displayingcount){
					 displayingcount = data.response.productListWithCount[0].count;
				}
			}
			// updating total product and loaded product
			$('#amountbottom').data('totalamount', toolbartotalcount);
			$('.footerpbar').data('last', displayingcount);
			$('.footerpbar').data('total', toolbartotalcount);
			$('.toolbarbottom .toolbar-number-diaplayed').html(displayingcount);
			$('.toolbarbottom .toolbar-number-total').html(toolbartotalcount);
			$('.top-toolbar-wrap .toolbar-amount').html(toolbartotalcount+" "+ $t('Items'));
			// add all filter facets
			if(type == 1 && toolbartotalcount > 0){ 
				$('body').removeClass('plp-no-product');
				var apptussearchFacet = apptussearchFacetsTemplate(data.response,1);
				$('#apptussearchFacets').html(apptussearchFacet);
				var apptussearchFacetAllfilter = apptussearchFacetsTemplate(data.response,2);
				var facetslistbar = '';
					facetslistbar += '<div id="layered-filter-block-container" class="layered-filter-block-container removeAllfiltercont">';
					facetslistbar += '<div class="block filter" id="layered-filter-block" data-collapsible="true">';
					facetslistbar += '<div class="block-content filter-content">';
					facetslistbar += '<div class="allfilters-filter-options" id="narrow-by-list" data-role="content" role="tablist">';
					facetslistbar += apptussearchFacetAllfilter;
					facetslistbar += '</div>';
					facetslistbar += '</div>';
					facetslistbar += '</div>';
					facetslistbar += '</div>';
					$('.removeAllfiltercont').remove();
					$('.hm-megawrapper .mf-header').after(facetslistbar);
					
					var checkedArray = {};
					$('#apptussearchFacets .checkboxChecked').each(function() {
						var value = this.value;
						if(this.name == 'color_filter') {
							var colorFilterValue = this.value;
							var colorvalue = colorFilterValue.split('_');
							if (colorvalue[0] != undefined && colorvalue[1] != undefined) {
								value = colorvalue[0];
							}
						}
						if(checkedArray.hasOwnProperty(this.name)){
							checkedArray[this.name] = checkedArray[this.name] + ', '+ $t(value);
						}else{
							checkedArray[this.name] = $t(value);
						}
					});
					$('.allfilters-filter-options .filter-options-item').each(function () {
						var item = $(this);
						var attributename = item.data('attribute');
						if(checkedArray[attributename] != undefined){
							$('.mfg_selected_'+attributename).html(checkedArray[attributename]);
						}else{
							$('.mfg_selected_'+attributename).html('');
						}
					});
					$('body').on('click', function (e) {
						if (!$('#apptussearchFacets .filter-options-item').is(e.target) 
							&& $('#apptussearchFacets .filter-options-item').has(e.target).length === 0 
							&& $('.active').has(e.target).length === 0
						) {
							$('#apptussearchFacets .filter-options-item').removeClass('active');
						}
					});
					$('#apptussearchFacets .filter-options-item').each(function () {
						var section = $(this);
						section.on('click', function(){
							$(this).addClass('allow').prevAll().addClass('allow');
							$(this).nextAll().removeClass('allow');
							$(this).nextAll().removeClass('active');
							$(this).prevAll().removeClass('active');
							$(this).toggleClass('active');
						});
					});
					changeMenuHeight()
			}			
			if(toolbartotalcount == 0){ 
				$('#apptussearchFacets').html('');
			}
			// updateing left category filter
			if($('.current_page_action').val() == 'catalogsearch_result_index'){
				if(data.response.categoryOverview != undefined){
					var categoryOverview = categoryOverviewTemplate(data.response);
					 $('.category-left-container').remove();
					 $('.hm-megawrapper').after(categoryOverview);
					 $('.salecategorytree button').click(function(){
						  $("#dropdown-sales").toggle();

							// Add status for the toggle.
							var parToggleEle = $(this).closest('.toggle-list-item');
							if (parToggleEle.hasClass('toggle-open')) {
								parToggleEle.removeClass('toggle-open');
							} else {
								$(this).attr('aria-expanded', true);
								parToggleEle.addClass('toggle-open');
							}
					 });
					 
				}
			}
			if(toolbartotalcount > 0){ 
				ajaxupdate.initObserve();
			}
			var statusBarLength = (displayingcount / toolbartotalcount) * 100;
			$('.p-current-bar').css('width',statusBarLength + '%');

			if (statusBarLength >= 75) {
				$('.p-current-bar .toolbar-number-diaplayed').css('right', 'inherit');
			}

			if(toolbartotalcount == 0){
				$('.p-current-bar').css("width",'0px');
				$('#toolbar-amountbottom').css("display","none");
				$('.hm-all-fil').css("display","none");
				$('.toolbar-products.top-toolbar').css("display","none");
				$('.category-left-container').remove();
				
			}else{
				$('.no-result-search').css('display','none');
				$('.hm-all-fil').css("display","block");
				$('.toolbar-amount').css("display","block");
				$('.toolbarbottom').css("display","block");
				$('#toolbar-amountbottom').css("display","block");
				$('.toolbar-products.top-toolbar').css("display","block");
			}
			
			if(displayingcount < toolbartotalcount){
				$('.apptus-load-more').css("display","block");
			}else{
				$('.apptus-load-more').css("display","none");
			}
			
			var top_items = $('#layer-product-list').find('li.item.product.product-item').length;
			jQuery('#top_toolbar-amount').find('.toolbar-number').html(top_items);
			$('.top-toolbar #ln_overlay').hide();
			
			var selectedFilterArr = '';
			var disbledattr = true;	
			$('#apptussearchFacets .checkboxChecked').each(function() {
				var removedspecialchrs = this.value;
				removedspecialchrs = removedspecialchrs.replace(/&/g, "%26");
				removedspecialchrs = removedspecialchrs.replace(/[^0-9a-zA-Z_]/g, "");
				if(this.name != 'sort_by'){
					if(this.name == 'color_filter'){
						var colorFilterValue = this.value;
						var colorvalue = colorFilterValue.split('_');
						if(colorvalue[0] != undefined && colorvalue[1] != undefined){
							colorFilterValue = colorvalue[0];
						}
						selectedFilterArr += '<li class="item"><span class="filter-label">'+this.name+'</span><span class="filter-value">' + $t(colorFilterValue) + '</span><a class="action remove" data-class="'+this.name+'_'+removedspecialchrs+'" href="javascript:void(0);" title="'+this.name+' '+this.value+'"></a>';
					}else{
						selectedFilterArr += '<li class="item"><span class="filter-label">'+this.name+'</span><span class="filter-value">' + $t(this.value) + '</span><a class="action remove" data-class="'+this.name+'_'+removedspecialchrs+'" href="javascript:void(0);" title="'+this.name+' '+this.value+'"></a>';
					}
				}
				disbledattr = false;
			}); 
			// enable disble clear all
			if (disbledattr == false) {
				$('.hm-megawrapper #mgf-clear').removeAttr("disabled");
			}else{
				$('.hm-megawrapper #mgf-clear').prop("disabled", true);
			}
			
			if(selectedFilterArr == ''){
				$('.filterCurrentAttrshowhide').css("display","none");
			}else{
				$('.filterCurrentAttrshowhide').css("display","block");
			}
			$('#filterCurrentAttr').html(selectedFilterArr);
			
			// update selected values in all filter window
			$('.allfilters-filter-options .filter-options-item').each(function () {
				var optionitem = $(this);
				var selectedvalues = '';
				optionitem.children('.checkboxChecked').each(function () {
					selectedvalues = $t(this.value) + ', ';
				});
				optionitem.children('mfg-selected').text(selectedvalues);
			});
			var sortbychecked = $(".allfilters-filter-options input[name='sortby']:checked").val();
			var sortbyName = '';
			if(sortbychecked == 'relevance'){ sortbyName = $t('Recommended'); }
			if(sortbychecked == 'is_new,desc'){ sortbyName = $t('Newest'); }
			if(sortbychecked == 'price,asc'){ sortbyName = $t('Lowest price'); }
			if(sortbychecked == 'price,desc'){ sortbyName = $t('Highest price'); }
			$('.mfg-selected-sortby').html(sortbyName);
			// update selected values in all filter window ended
			
			 addToWishlistBag();
			// load category page you may also like
			if($('.current_page_action').val() == 'catalog_category_view'){
				if(data.response.recommendBasedOnCustomer != undefined && data.response.recommendBasedOnCustomer[0] != undefined){
					plpYouMayAlsoLike(data.response.recommendBasedOnCustomer[0]);
				}
				if(data.response.productListWithCount[0] != null && data.response.productListWithCount[0] != undefined && data.response.productListWithCount[0].count <= 0){
					apptusFallbackFewResults();
				}
			}
		}).then(function () {
			if (performance.navigation.type == performance.navigation.TYPE_BACK_FORWARD) {
				if ($.cookie('list-page-offset') && !isNaN(parseInt($.cookie('list-page-offset'), 10))) {
					if (getMobileOperatingSystem() && getMobileOperatingSystem() === 'iOS') {
						document.cookie = "list-page-offset-url=" + window.location.href + "; path=/";
					}
					$('html, body').animate({
						scrollTop: $.cookie('list-page-offset')
					});
					// $.cookie('list-page-offset', '', { path: '/' })
					document.cookie = "list-page-offset=; path=/";
				}
			}
			$(window).scroll(function () {
				document.cookie = "list-page-offset=" + window.pageYOffset + "; path=/";
			})
			$(window).on('touchmove', function () {
				document.cookie = "list-page-offset=" + window.pageYOffset + "; path=/";
			})
		}).catch(function(data) {
			$('.top-toolbar #ln_overlay').hide();
			//apptusFallbackFewResults();
		});
	}

	function getMobileOperatingSystem() {
		var userAgent = navigator.userAgent || navigator.vendor || window.opera;

		// iOS detection from: http://stackoverflow.com/a/9039885/177710
		if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream || isIpadOS() || isMacOS()) {
			return "iOS";
		}

		return false;
	}

	function isIpadOS() {
		return navigator.maxTouchPoints &&
			navigator.maxTouchPoints > 2 &&
			/MacIntel/.test(navigator.platform);
	}

	function isMacOS() {
		return /Mac/.test(navigator.platform);
	}

	$(window).on('load', function() {
		getVisible();
		changeMenuHeight();
	});

	function getTodayDate() {
		var todayDate = new Date();
		var y = todayDate.getFullYear();
		var m = todayDate.getMonth() + 1;
		var d = todayDate.getDate();
		if(d < 10) { d = "0"+d; }
		if(m < 10) { m = "0"+m; }
		var today = y+'-'+m+'-'+d+'T00:00:00Z';
		return today;
	}

	function removeURLParameter(param, url) {
		url = decodeURI(url).split("?");
		path = url.length == 1 ? "" : url[1];
		path = path.replace(new RegExp("&?"+param+"\\[\\d*\\]=[\\w]+", "g"), "");
		path = path.replace(new RegExp("&?"+param+"=[\\w]+", "g"), "");
		path = path.replace(/^&/, "");
		return url[0] + (path.length
			? "?" + path
			: "");
	}
	
	//$(document).ready(function() {
			var loadUrl = '';
			var offset = findUrlParamAvailableValue('offset');
		if($('.current_page_action').val() == 'catalogsearch_result_index'){
			/* if (window.location.search.indexOf('&cat=') > -1) {
				var newUrl= removeURLParameter('cat', window.location.href);
				window.location.replace(newUrl);
			}
				 */		
			$('.top-toolbar #ln_overlay').show();
			var lastdata = $('.search_page_first_loadingcount').val();
			if(offset != ''){
				var offsetsplit = offset.split(',');
				if(offsetsplit[1] != undefined){
					lastdata = offsetsplit[1];
				}
			}
			categoryName = lastdata;
			loadUrl = '/search-result';
			loadApptusDataSearch(1, lastdata, 1, loadUrl, null, null);
			
			var formSubmittingcl = false;
			$('#search_mini_form').submit(function (e) {
				/** change browser url */
				e.preventDefault();
				e.stopImmediatePropagation();
				var searchCookieKey = getCookie('searchKeyword');
				console.log(searchCookieKey);
				if(searchCookieKey == 0){
					 
					$('.top-toolbar #ln_overlay').show();
					var lastdata = $('.search_page_first_loadingcount').val();
					if(offset != ''){
						var offsetsplit = offset.split(',');
						if(offsetsplit[1] != undefined){
							lastdata = offsetsplit[1];
						}
					}
					loadUrl = '/search-result';
					formSubmittingcl = true;
					loadApptusDataSearch(1, lastdata, 1, loadUrl, null, 1);
					
					// set cookie for search
						var date = new Date();
						date.setTime(date.getTime() + (5 * 1000));
						var expires = '; expires=' + date.toGMTString();
						var searchname = 'searchKeyword';
						var searchvalue = document.getElementById('search').value.trim();
						document.cookie = searchname + '=' + searchvalue + expires + '; path=/; secure=false';
				}
			});
			 
			$('#search_mini_form .action.search').on('click', function (e) {
				/** change browser url */
				if(formSubmittingcl == false){
					e.preventDefault();
					$('.top-toolbar #ln_overlay').show();
					var lastdata = $('.search_page_first_loadingcount').val();
					if(offset != ''){
						var offsetsplit = offset.split(',');
						if(offsetsplit[1] != undefined){
							lastdata = offsetsplit[1];
						}
					}
					loadUrl = '/search-result';
					loadApptusDataSearch(1, lastdata, 1, loadUrl, null, 1);
				}
			});
		}
		
		if($('.current_page_action').val() == 'catalog_category_view'){
			var listItems = document.querySelectorAll('.breadcrumbs .items li');
			var listItemslength = listItems.length;
			if(listItemslength > 3){
				$('.top-toolbar #ln_overlay').show();
				var lastdata = $('.search_page_first_loadingcount').val();
				if(offset != ''){
					var offsetsplit = offset.split(',');
					if(offsetsplit[1] != undefined){
						lastdata = offsetsplit[1];
					}
				}
				loadUrl = '/navigation-product-list';
				loadApptusDataSearch(1, lastdata, 1, loadUrl, null, null);
			}
		}
		
		$(document).on('click', '#showmore', function() {
			var countdisplayed = $('.toolbarbottom .toolbar-number-diaplayed').text();
			var loadMoreCountdata = parseInt(countdisplayed)+parseInt($('.search_page_first_loadingcount').val());
			var totalCount = $('.toolbarbottom .toolbar-number-total').text();
			if(loadMoreCountdata >  totalCount){
				loadMoreCountdata = totalCount;
			}
			//------------------
			var hrefpath = window.location.href;
			var pathurls = hrefpath.split('?');
			var url = '?';
			if(pathurls[1] != undefined){
				var query = pathurls[1];
				var vars = query.split('&');
				for (var i = 0; i < vars.length; i++) {
					var pair = vars[i].split('=');
					if(pair[0] != "" && pair[1] != "" && pair[0] != undefined && pair[1] != undefined){
						if(pair[0] != 'offset'){
							url += '&'+pair[0]+'='+pair[1];
						}
					}
				}
			}
			url += '&offset=1,'+loadMoreCountdata;
			
			var submitUrl = pathurls[0]+url;
			window.history.pushState({url: submitUrl}, '', submitUrl);
		//--------------------------	
		
			isShowMore = true;
			$('.top-toolbar #ln_overlay').show();
			var firstwindowNext = parseInt($('.toolbarbottom .toolbar-number-diaplayed').text())+1;
			loadApptusDataSearch(firstwindowNext, loadMoreCountdata, 2, loadUrl, null, null);
			
		});
		
		
		if($('.current_page_action').val() == 'checkout_cart_index'){
			apptusCartYoumayalsoAndPopular();
		}
		
		$('.filter-current .filter-current-subtitle').click(function(){
			  $("#filterCurrentAttr").toggle();
		 });
					 
	//}, false);
	
	if($('.current_page_action').val() == 'catalog_product_view'){
		var isvoucherproduct = $('.product-info').data('isvoucher');
		if(isvoucherproduct == 0){
			/* var lowercaseMarketid = $('.market_id').val().toLowerCase();
			var product_key = articlenumberValue.trim()+'_'+lowercaseMarketid;
			apptusProductPageStyleWith(product_key);
			apptusOthersAlsoBought(product_key); */
		}else{
			$('.pdp-widget-container').removeClass('widget-loader');
		}
	}
	// clear filter
	$('body').on('click', '#filterCurrentAttr li a', function (e) {
		var dataClass = $(this).data('class');
		$('.checkbox_'+dataClass).each(function () {
			if ($(this).hasClass('checkboxChecked')) {
				$(this).removeClass('checkboxChecked');
				$(this).prop('checked', true);
			}else{
				$(this).addClass('checkboxChecked');
				$(this).prop('checked', false);
			}
		});
		
		$('.selected_'+dataClass).remove();
		var urlStr = window.location.href;
		var paramUrls = urlStr.split('?');
		var baseurlSearch = paramUrls[0];
		var currentUrl = '';
		if($('body').hasClass('catalogsearch-result-index')){
			currentUrl = baseurlSearch+'?q='+document.getElementById('search').value.trim();
		}
		
		if($('body').hasClass('catalog-category-view')){
			currentUrl = baseurlSearch+'?';
		}
		
		var checkedArray = {};
		var selectedFilterArr = '';
		$('#apptussearchFacets .checkboxChecked').each(function() {
			if(checkedArray.hasOwnProperty(this.name)){
				var existArrayval = checkedArray[this.name];
				checkedArray[this.name] = existArrayval+','+this.value;
			}else{
				checkedArray[this.name] = this.value;
			}
			// selected filters
			
			var removedspecialchrs = this.value;
			removedspecialchrs = removedspecialchrs.replace(/&/g, "%26");
			removedspecialchrs = removedspecialchrs.replace(/[^0-9a-zA-Z_]/g, "");
			if(this.name != 'sort_by'){
				if(this.name == 'color_filter'){
					var colorFilterValue = this.value;
					var colorvalue = colorFilterValue.split('_');
					if(colorvalue[0] != undefined && colorvalue[1] != undefined){
						colorFilterValue = colorvalue[0];
					}
					selectedFilterArr += '<li class="item"><span class="filter-label">'+this.name+'</span><span class="filter-value">'+colorFilterValue+'</span><a class="action remove" data-class="'+this.name+'_'+removedspecialchrs+'" href="javascript:void(0);" title="'+this.name+' '+this.value+'"></a>';
				}else{
					selectedFilterArr += '<li class="item"><span class="filter-label">'+this.name+'</span><span class="filter-value">'+this.value+'</span><a class="action remove" data-class="'+this.name+'_'+removedspecialchrs+'" href="javascript:void(0);" title="'+this.name+' '+this.value+'"></a>';
				}
			}
		});
		
		if(selectedFilterArr == ''){
			$('.filterCurrentAttrshowhide').css("display","none");
		}else{
			$('.filterCurrentAttrshowhide').css("display","block");
		}
		$('#filterCurrentAttr').html(selectedFilterArr);
					
		
		var ajaxurlParams = '';
		var paramKeyArraysAjax = Object.keys(checkedArray);
		for (var l=0; l <= paramKeyArraysAjax.length; l++) {
			if(paramKeyArraysAjax[l] != undefined){
				ajaxurlParams += '&'+paramKeyArraysAjax[l]+'='+checkedArray[paramKeyArraysAjax[l]];
			}
		}
		var link = currentUrl+ajaxurlParams;
		e.stopPropagation();
		e.preventDefault();
		return submitFilterAction(link, 1);
	});
//-----------------
	var selectedColor = '';
	var selectedColorSize = '';
	$('body').on('click', 'ul.listChipColorclass li', function() {
		selectedColor = $(this).attr('color');
		var colorarticlenumbervalue = '';
		if(allProductsTinyInformation != undefined && allProductsTinyInformation != ''){
			var productTicket = allProductsTinyInformation.ticket;
			if(allProductsTinyInformation.products != undefined){
				var allProdcutsData = allProductsTinyInformation.products;
				var allProdcutsDatalength = allProdcutsData.length;
				for(var pro = 0;pro < allProdcutsDatalength; pro++){
					var variant = allProdcutsData[pro];
					var variantTicket = variant.ticket;
					var attributes = variant.attributes;
					if(attributes.entity_id != undefined && attributes.entity_id[0] != undefined && attributes.color_code != undefined && attributes.color_code[0] != undefined){
						if(attributes.color_code[0] === selectedColor){
							api.notify.click(variantTicket);
							colorarticlenumbervalue = variant.key;
							apptusProductPageStyleWith(colorarticlenumbervalue);
							apptusOthersAlsoBought(colorarticlenumbervalue);
						}
					}
				}
			}
		}else{
			var lowercaseMarketid = $('.market_id').val().toLowerCase();
			var product_key = articlenumberValue.trim()+'_'+lowercaseMarketid;
			apptusProductPageStyleWith(product_key);
			apptusOthersAlsoBought(product_key);
		}
	});
	
	//$('#picker-ul li').each(function(){
	//var section = $(this);
	$('body').on('click', '#picker-ul li', function(){
		//push aaptus notification
		var entity_id = $(this).data('pid');
		if(productInformation != undefined && entity_id!= undefined && entity_id!=''){
			var productTicket = productInformation.ticket;
			if(productInformation.products != undefined){
				var allProdcutsData = productInformation.products;
				var allProdcutsDatalength = allProdcutsData.length;
				for(var pro = 0;pro < allProdcutsDatalength; pro++){
					var product = allProdcutsData[pro];
					var variants = product.variants;
					for(var vrt = 0;vrt < variants.length; vrt++){
						var variant = variants[vrt];
						var attributes = variant.attributes;
						var variantTicket = variant.ticket;
						if(attributes.entity_id != undefined && attributes.entity_id[0] != undefined && entity_id!= undefined && entity_id!='' && attributes.entity_id == entity_id){											
							api.notify.click(variantTicket);
							continue;
						}
					}
				}
			}
		}
	});

	// quick view click api call
	/** $('body').on('click', '.quickView', function() {
		selectedProductKey = $(this).data('productkey');
		var allProdcuts = $(this).data('allproduct');
		var fb = new api.utils.FilterBuilder();
		var filter = fb.attribute('market_id', $('.market_id').val());
		var lowercaseMarketid = $('.market_id').val().toLowerCase();
		api.panel('/product-details-page', {
			market_id: $('.market_id').val(),
			product_key: selectedProductKey.trim(),
			all_products: allProdcuts,
			filter: filter.toString() + " AND (status:'true') ",
			window_first:1,
			window_last:12
		}).then(function(data) {
			if(data.response.productInformation != undefined && data.response.productInformation[0] != undefined){
				productInformation = data.response.productInformation[0];
			}
			if(data.response.allProductsTinyInformation != undefined && data.response.allProductsTinyInformation[0] != undefined){
				allProductsTinyInformation = data.response.allProductsTinyInformation[0];
			}
		}).catch(function(data) {
			//console.log('Error: ', data);
		});
		
	}); */
	$('body').on('click', '.qview-color-swatch-wrapper li', function() {
		selectedColor = $(this).data('colorlabel');
		var colorarticlenumbervaluequick = '';
		if(allProductsTinyInformation != undefined){
			var productTicket = allProductsTinyInformation.ticket;
			if(allProductsTinyInformation.products != undefined){
				var allProdcutsData = allProductsTinyInformation.products;
				var allProdcutsDatalength = allProdcutsData.length;
				for(var pro = 0;pro < allProdcutsDatalength; pro++){
					var variant = allProdcutsData[pro];
					var variantTicket = variant.ticket;
					var attributes = variant.attributes;
					if(attributes.entity_id != undefined && attributes.entity_id[0] != undefined && attributes.color_code != undefined && attributes.color_code[0] != undefined){
						if(attributes.color_code[0] === selectedColor){
							api.notify.click(variantTicket);
							colorarticlenumbervaluequick = variant.key;
						}
					}
				}
			}
		}
			//apptusOthersAlsoBought(colorarticlenumbervaluequick);
	});
	$('body').on('change', '#sizechip', function(){
		var entity_id = $(this).find("option:selected").data("pid");
		if(productInformation != undefined && entity_id!= undefined && entity_id!=''){
			var productTicket = productInformation.ticket;
			if(productInformation.products != undefined){
				var allProdcutsData = productInformation.products;
				var allProdcutsDatalength = allProdcutsData.length;
				for(var pro = 0;pro < allProdcutsDatalength; pro++){
					var product = allProdcutsData[pro];
					var variants = product.variants;
					for(var vrt = 0;vrt < variants.length; vrt++){
						var variant = variants[vrt];
						var attributes = variant.attributes;
						var variantTicket = variant.ticket;
						if(attributes.entity_id != undefined && attributes.entity_id[0] != undefined && entity_id!= undefined && entity_id!='' && attributes.entity_id == entity_id){											
							api.notify.click(variantTicket);
							continue;
						}
					}
				}
			}
		}
	});
	$('body').on('click', '.qvButtonWrapper button', function(){
	//push aaptus notification
		var entity_id = $('.qvButtonWrapper input[name=product]').val();
		if(productInformation != undefined && entity_id!= undefined && entity_id!=''){
			var productTicket = productInformation.ticket;
			if(productInformation.products != undefined){
				var allProdcutsData = productInformation.products;
				var allProdcutsDatalength = allProdcutsData.length;
				for(var pro = 0;pro < allProdcutsDatalength; pro++){
					var product = allProdcutsData[pro];
					var variants = product.variants;
					for(var vrt = 0;vrt < variants.length; vrt++){
						var variant = variants[vrt];
						var attributes = variant.attributes;
						var variantTicket = variant.ticket;
						if(attributes.entity_id != undefined && attributes.entity_id[0] != undefined && entity_id!= undefined && entity_id!='' && attributes.entity_id[0] == entity_id){
							api.notify.addToCart(variantTicket);//api.notify.click(variantTicket);
							continue;
						}
					}
				}
			}
		}
	});	
   /*Mega Filter Starts*/
	var clicked;
	$(document).on('click', '.allfilters-btn, #mgf-done, .mgf-overlay, .mf-header .mf-close', function () {
		if (($(".filter-options-item.active").has(event.target).length == 0 && !$(".filter-options-item.active").is(event.target)) && clicked != 1) {
			$(".filter-options-item.active .filter-options-title").trigger('click');
			clicked = 1;
		}
		$('.hm-megawrapper').toggleClass('active');
		$('.block-search').toggleClass('v-hidden');
		$('body').toggleClass('no-scroll mgf-open-body');
			
			$('.hm-megawrapper.active .filter-options-item').each(function() {
				$(this).click(function () {
					$(this).toggleClass('active');
					if ($(this).children('.filter-options-content').children('.ln-items-colections').children('li').length > 11 ) {
						$(this).children('.filter-options-content').css('height','auto');
					}else{
						$(this).children('.filter-options-content').css('height','170%');
					}
					$(this).children('.filter-options-content').css('display','block');
					$('.hm-megawrapper.active .mf-header').addClass('child-open');
					let attributeCode = $(this).data('attribute');
					if (attributeCode == 'sortby') {
						attributeCode = 'Sort by';
					} else if (attributeCode == 'color_filter') {
						attributeCode = 'Color';
					} else if (attributeCode == 'presentation_product_type') {
						attributeCode = 'Product type';
					} else {
						attributeCode = attributeCode.charAt(0).toUpperCase() + attributeCode.slice(1);
					}
					$('.hm-megawrapper.active .mgf-h-text').html($t(attributeCode));
				});
			});
			
			$(document).on('click', '.mfg-back-btn', function () {
				$('.hm-megawrapper.active .mf-header').removeClass('child-open');
				$('.hm-megawrapper.active .mgf-h-text').html($t('Filter'));
				$('.hm-megawrapper.active .filter-options-item').each(function() {
					$(this).removeClass('active');
					$(this).children('.filter-options-content').css('display','none');
				});
			});
	});
	$(document).on('click', '#mgf-clear', function () {
		$('.hm-megawrapper .filter-clear').trigger('click');
	});
	$(document).on('click', '.mfg-back-btn', function () {
		$('.hm-megawrapper.active').find('.filter-options-item.active .filter-options-title').trigger('click');
	});
	/*Mega Filter Ends*/
	
	function removeScriptTag(searchquery){
		var regex = /(<script[^>]+>|<script>|<\/script>)/g;
		var removedScripTag = searchquery.replace(regex , ' ');
		return removedScripTag;
	}

	function removeXss(searchQuery) {
		return String(searchQuery).replace(/[^\w-_. ]/gi, function (c) {
				return c;
		});
	}

		function isComingSoon(online_date, launch_date) {
			if (online_date != undefined && online_date != '' && launch_date != undefined && launch_date != '') {
				var current_date = new Date();
				var online_date = new Date(online_date);
				var launch_date = new Date(launch_date);
				if (online_date < current_date && launch_date > current_date) {
					return true;
				} else {
					return false;
				}
			}
		}
});